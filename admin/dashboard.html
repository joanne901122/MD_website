<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台管理 | 明德車業 MINGDE MOTOR</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/mobile-menu.css" media="screen and (max-width: 992px)">
    <style>
        /* 覆蓋預設樣式以符合MD品牌 */
        :root {
            --kawa-green: var(--md-primary);
            --plaza-black: var(--md-text);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        /* 狀態標籤樣式 */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        /* 操作按鈕樣式 */
        .action-buttons {
            white-space: nowrap;
            text-align: center;
        }
        
        .btn-action {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
            margin: 0 2px;
        }
        
        .btn-action:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .btn-edit {
            color: #007bff;
        }
        
        .btn-edit:hover {
            color: #0056b3;
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .btn-delete {
            color: #dc3545;
        }
        
        .btn-delete:hover {
            color: #bd2130;
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        /* 提示消息樣式 */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-success {
            background-color: var(--success-color);
        }
        
        .toast-error {
            background-color: var(--danger-color);
        }
        
        .toast-warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        body {
            background-color: var(--md-light-gray);
            color: var(--md-text);
        }
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --light-gray: #f5f6fa;
            --dark-gray: #2d3436;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* 側邊欄樣式 */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .menu-item.active {
            background-color: var(--secondary-color);
            border-left: 4px solid white;
        }

        /* 主內容區 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        /* 表格樣式 */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        /* 按鈕樣式 */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* 表單樣式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- MD 管理後台頂部導航 -->
    <div class="admin-topbar">
        <div class="admin-topbar-content">
            <div class="admin-logo">
                <img src="../image/logo.jpg" alt="明德車業 Logo" class="logo-img">
                <span>明德車業 後台管理</span>
            </div>
            <div class="admin-user">
                <span class="admin-username"><i class="fas fa-user"></i> 管理員</span>
                <a href="../index.html" class="btn btn-sm btn-outline">返回官網</a>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- 側邊欄 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-bars"></i> 主選單</h3>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> 儀表板
                </li>
                <li class="menu-divider">車輛管理</li>
                <li class="menu-item" data-tab="inventory">
                    <i class="fas fa-warehouse"></i> 現車庫存管理
                </li>
                <li class="menu-divider">預約管理</li>
                <li class="menu-item" data-tab="test-drive">
                    <i class="fas fa-car"></i> 賞車預約
                </li>
                <li class="menu-item" data-tab="maintenance">
                    <i class="fas fa-tools"></i> 保養預約
                </li>
                <li class="menu-divider">活動管理</li>
                <li class="menu-item" data-tab="events">
                    <i class="fas fa-calendar-alt"></i> 活動報名
                </li>
                <li class="menu-divider">業績管理</li>
                <li class="menu-item" data-tab="sales-today">
                    <i class="fas fa-sun"></i> 今日業績
                </li>
                <li class="menu-item" data-tab="sales-month">
                    <i class="fas fa-calendar-alt"></i> 本月業績
                </li>
                <li class="menu-divider">系統</li>
                <li class="menu-item">
                    <i class="fas fa-cog"></i> 系統設定
                </li>
                <li class="menu-item">
                    <i class="fas fa-sign-out-alt"></i> 登出系統
                </li>
            </ul>
        </div>

        <!-- 主內容區 -->
        <div class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-tachometer-alt"></i> 儀表板</h1>
                <div class="breadcrumb">
                    <a href="#">首頁</a> / <span>儀表板</span>
                </div>
            </div>

            <!-- 統計卡片 -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1);">
                        <i class="fas fa-wrench" style="color: #2ecc71;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>今日預約保養</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1);">
                        <i class="fas fa-car" style="color: #3498db;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>今日賞車預約</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1);">
                        <i class="fas fa-calendar-check" style="color: #9b59b6;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>活動報名人數</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1);">
                        <i class="fas fa-warehouse" style="color: #f1c40f;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>現車庫存</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <!-- 業績統計已移至業績管理分頁：sales-today / sales-month -->
            </div>

            <!-- 預約保養管理 -->
            <div class="card" id="maintenance-section">
                <div class="card-header">
                    <span>預約保養管理</span>
                    <div>
                        <button class="btn btn-primary btn-sm" id="refresh-maintenance">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                       
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table" id="maintenance-table">
                            <thead>
                                <tr>
                                    <th>預約時間</th>
                                    <th>姓名</th>
                                    <th>電話</th>
                                    <th>車型</th>
                                    <th>服務類型</th>
                                    <th>備註</th>
                                    <th>保養價錢</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 數據會在這裡動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 業績管理：今日業績 -->
            <div class="card" id="sales-today-section" style="display:none;">
                <div class="card-header">
                    <span>今日業績</span>
                    <div>
                        <input type="date" id="sales-today-date" style="margin-right:8px;">
                        <button class="btn btn-primary btn-sm" id="refresh-sales-today">刷新業績</button>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:flex; gap:16px; margin-bottom:16px;">
                        <div style="flex:1; background:#fff; padding:12px; border-radius:6px; box-shadow:var(--card-shadow);">
                            <h4>今日業績</h4>
                            <p id="sales-today-amount">0</p>
                            <small id="sales-today-note">以完成項目計</small>
                        </div>
                    </div>
                    <div>
                        <h5>今日明細（完成）</h5>
                        <table class="table" id="sales-today-table">
                            <thead>
                                <tr><th>日期</th><th>姓名</th><th>項目</th><th>金額</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 業績管理：本月業績 -->
            <div class="card" id="sales-month-section" style="display:none;">
                <div class="card-header">
                    <span>本月業績</span>
                    <div>
                        <input type="month" id="sales-month-month" style="margin-right:8px;">
                        <button class="btn btn-primary btn-sm" id="refresh-sales-month">刷新業績</button>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:flex; gap:16px; margin-bottom:16px;">
                        <div style="flex:1; background:#fff; padding:12px; border-radius:6px; box-shadow:var(--card-shadow);">
                            <h4>本月業績</h4>
                            <p id="sales-month-amount">0</p>
                            <small id="sales-month-note">以完成項目計</small>
                        </div>
                    </div>
                    <div>
                        <h5>本月明細（完成）</h5>
                        <table class="table" id="sales-month-table">
                            <thead>
                                <tr><th>日期</th><th>姓名</th><th>項目</th><th>金額</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 預約賞車管理 -->
            <div class="card" id="test-drive-section" style="display: none;">
                <div class="card-header">
                    <span>預約賞車管理</span>
                    <div>
                        <button class="btn btn-primary btn-sm" id="refresh-test-drive">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                        
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>預約編號</th>
                                    <th>客戶姓名</th>
                                    <th>聯絡電話</th>
                                    <th>預約日期</th>
                                    <th>品牌 / 車型</th>
                                    <th>備註</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                    <th>人員備註</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 活動報名管理 -->
            <div class="card" id="events-section" style="display: none;">
                <div class="card-header">
                    <span>活動報名管理</span>
                    <div>
                        <button class="btn btn-primary btn-sm" id="refresh-events">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                        <button class="btn btn-primary btn-sm" id="add-event">
                            <i class="fas fa-plus"></i> 新增活動
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>活動名稱</th>
                                    <th>活動日期</th>
                                    <th>地點</th>
                                    <th>報名人數</th>
                                    <th>報名狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024 新車發表會</td>
                                    <td>2024/01/15 14:00</td>
                                    <td>台北展示中心</td>
                                    <td>45/100</td>
                                    <td><span style="color: var(--success-color);">報名中</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm">名單</button>
                                        <button class="btn btn-primary btn-sm">編輯</button>
                                        <button class="btn btn-danger btn-sm">刪除</button>
                                    </td>
                                </tr>
                                <!-- 更多活動資料 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 現車庫存管理 -->
            <div class="card" id="inventory-section" style="display: none;">
                <div class="card-header">
                    <span>現車庫存管理</span>
                    <button class="btn btn-primary btn-sm" id="add-inventory">
                        <i class="fas fa-plus"></i> 新增車輛
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>車型</th>
                                    <th>顏色</th>
                                    <th>年份</th>
                                    <th>里程數</th>
                                    <th>售價</th>
                                    <th>庫存狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ABC-1234</td>
                                    <td>Model 3</td>
                                    <td>珍珠白</td>
                                    <td>2023</td>
                                    <td>1,234 公里</td>
                                    <td>1,650,000 元</td>
                                    <td><span style="color: var(--success-color);">在庫</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm">編輯</button>
                                        <button class="btn btn-danger btn-sm">刪除</button>
                                    </td>
                                </tr>
                                <!-- 更多庫存資料 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯表單模態框 -->
    <div class="modal" id="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <h3 id="modalTitle" style="margin:0; font-size:1.1rem;"></h3>
                    <button id="closeModal" style="background:transparent; border:none; font-size:1.6rem; line-height:1; cursor:pointer;">&times;</button>
                </div>
            <div class="modal-body" id="formContent">
                <!-- 表單內容將由JavaScript動態生成 -->
            </div>
        </div>
    </div>

    <style>
        /* 自定義樣式 */
        .admin-topbar {
            background: var(--md-white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .admin-topbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .admin-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-logo .logo-img {
            height: 40px;
            width: auto;
        }
        
        .admin-logo span {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--md-text);
        }
        
        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-username {
            color: var(--md-text);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--md-primary);
            color: var(--md-primary);
        }
        
        .btn-outline:hover {
            background: var(--md-primary);
            color: white;
        }
        
        .menu-divider {
            padding: 10px 25px;
            font-size: 0.85rem;
            color: var(--md-text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
        }
        
        .menu-divider:first-child {
            margin-top: 0;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            color: var(--md-text);
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .breadcrumb {
            color: var(--md-text-light);
            font-size: 0.9rem;
        }
        
        .breadcrumb a {
            color: var(--md-primary);
            text-decoration: none;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-info h3 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
            color: var(--md-text-light);
            font-weight: normal;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0 0 5px 0;
            color: var(--md-text);
        }
        
        .stat-change {
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .stat-change.up {
            color: var(--md-success);
        }
        
        .stat-change.down {
            color: var(--md-danger);
        }
    </style>
    
    <script>
        // 全局變量
        let currentTab = 'dashboard';
        let currentModal = null;
        
        // 載入表單提交數據（統一由各 loadAndDisplay* 與 updateAllStats 處理）
        function loadFormSubmissions() {
            // 重新計算所有統計並載入保養列表
            if (typeof updateAllStats === 'function') updateAllStats();
            loadAndDisplayMaintenance();
        }
        
        // 更新統計卡片
        function updateStatCard(type, count) {
            if (type === 'maintenance') {
                const statNumber = document.querySelector('#maintenance-stat .stat-number');
                const statChange = document.querySelector('#maintenance-stat .stat-change');
                
                if (statNumber) statNumber.textContent = count;
                if (statChange) {
                    statChange.innerHTML = count > 0 ? 
                        '<i class="fas fa-arrow-up"></i> ' + count + ' 筆預約' : 
                        '尚無資料';
                    statChange.className = 'stat-change ' + (count > 0 ? 'up' : '');
                }
            }
        }
        
        // 更新預約表格
        function updateAppointmentTable(appointments) {
            const tbody = document.querySelector('#maintenance-section tbody');
            if (!tbody) return;
            
            tbody.innerHTML = ''; // 清空現有數據
            
            if (appointments.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" class="no-data">沒有找到相關數據</td>';
                tbody.appendChild(tr);
                return;
            }
            
            // 按日期排序，最新的在前面
            appointments.sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));
            
            appointments.forEach(appointment => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${appointment.id || ''}</td>
                    <td>${appointment.name || ''}</td>
                    <td>${appointment.phone || ''}</td>
                    <td>${appointment.bookingDate || ''} ${appointment.bookingTime || ''}</td>
                    <td>${appointment.bikeModel || ''}</td>
                    <td>${appointment.licensePlate || 'N/A'}</td>
                    <td><span class="status-badge status-pending">待處理</span></td>
                    <td class="action-buttons">
                        <button class="btn-edit" onclick="editItem('maintenance', '${appointment.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" onclick="deleteItem('maintenance', '${appointment.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadFormSubmissions();
            // 載入表單提交數據
            loadAndDisplayMaintenance();
            
            // 添加保養預約刷新按鈕事件監聽
            const refreshMaintenanceBtn = document.getElementById('refresh-maintenance');
            if (refreshMaintenanceBtn) {
                refreshMaintenanceBtn.addEventListener('click', loadAndDisplayMaintenance);
            }
            
            // 添加賞車預約刷新按鈕事件監聽
            const refreshTestDriveBtn = document.getElementById('refresh-test-drive');
            if (refreshTestDriveBtn) {
                refreshTestDriveBtn.addEventListener('click', loadAndDisplayTestDrives);
            }
            
            // 添加活動報名刷新按鈕事件監聽
            const refreshEventsBtn = document.getElementById('refresh-events');
            if (refreshEventsBtn) {
                refreshEventsBtn.addEventListener('click', loadAndDisplayEvents);
            }
            
            // 初始化時載入所有數據
            loadAndDisplayTestDrives();
            loadAndDisplayEvents();
            // 初始化庫存統計與所有統計
            if (typeof updateInventoryCount === 'function') updateInventoryCount();
            if (typeof updateAllStats === 'function') updateAllStats();
            // 綁定個別業績刷新按鈕（若存在）以避免在分頁載入時遺漏
            const salesTodayBtn = document.getElementById('refresh-sales-today');
            if (salesTodayBtn) salesTodayBtn.addEventListener('click', function() { 
                const d = document.getElementById('sales-today-date');
                const val = d ? d.value : '';
                if (typeof updateRevenueStats === 'function') updateRevenueStats('today', val || undefined);
            });
            const salesMonthBtn = document.getElementById('refresh-sales-month');
            if (salesMonthBtn) salesMonthBtn.addEventListener('click', function() { 
                const m = document.getElementById('sales-month-month');
                const val = m ? m.value : '';
                if (typeof updateRevenueStats === 'function') updateRevenueStats('month', val || undefined);
            });
            // 設定預設日期/月份為今日與本月
            const todayInput = document.getElementById('sales-today-date');
            if (todayInput && !todayInput.value) todayInput.value = new Date().toISOString().split('T')[0];
            const monthInput = document.getElementById('sales-month-month');
            if (monthInput && !monthInput.value) {
                const now = new Date();
                monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            }
        });

        // 當其他頁面修改 localStorage 時，自動更新此頁面列表與統計
        window.addEventListener('storage', function(e) {
            if (e.key === 'formSubmissions') {
                try {
                    loadFormSubmissions();
                } catch (err) {
                    // ignore if function not available
                }
                if (typeof loadAndDisplayMaintenance === 'function') loadAndDisplayMaintenance();
                if (typeof loadAndDisplayTestDrives === 'function') loadAndDisplayTestDrives();
                if (typeof loadAndDisplayEvents === 'function') loadAndDisplayEvents();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        });
        
        // 載入並顯示保養預約數據
        function loadAndDisplayMaintenance() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#maintenance-table tbody');
            
            if (!tableBody) {
                console.error('找不到表格主體元素');
                return;
            }
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            // 過濾出保養預約
            const maintenanceSubmissions = submissions.filter(sub => sub.type === 'maintenance');
            
            // 更新今日預約保養計數（排除已完成項目）
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = maintenanceSubmissions.filter(sub => sub.date === today && sub.status !== 'completed');
            updateTodayAppointmentCount(todayAppointments.length);
            
            if (maintenanceSubmissions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暫無預約記錄</td></tr>';
                return;
            }
            
            // 按日期和時間排序（最近的排前面）
            maintenanceSubmissions.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateA - dateB;
            });
            
            maintenanceSubmissions.forEach((submission, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${submission.date || ''} ${submission.time || ''}</td>
                    <td>${submission.name || ''}</td>
                    <td>${submission.phone || ''}</td>
                    <td>${submission.bikeModel || ''}</td>
                    <td>${getServiceTypeText(submission.serviceType)}</td>
                    <td>${submission.notes || ''}</td>
                    <td>
                        <div class="price-edit" data-id="${submission.id}">
                            <input type="text" class="price-input" value="${submission.price || ''}" placeholder="輸入價格" 
                                   onchange="updatePrice('${submission.id}', this.value)" 
                                   onblur="this.value = this.value.replace(/[^\d.]/g, '')"
                                   style="width: 80px; text-align: right;"
                                   ${submission.status === 'completed' ? 'readonly' : ''}>
                            <span>元</span>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${submission.status === 'completed' ? 'status-completed' : 'status-pending'}">
                            ${submission.status === 'completed' ? '已完成' : '未處理'}
                        </span>
                    </td>
                    <td>
                        <button class="btn-edit" onclick="updateStatus('${submission.id}', '${submission.status === 'completed' ? 'pending' : 'completed'}')">
                            ${submission.status === 'completed' ? '未完成' : '已完成'}
                        </button>
                        <button class="btn-delete" onclick="deleteSubmission('${submission.id}')">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 載入並顯示賞車預約數據
        function loadAndDisplayTestDrives() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#test-drive-section tbody');
            
            if (!tableBody) {
                console.error('找不到賞車預約表格主體元素');
                return;
            }
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            // 過濾出賞車預約
            const testDriveSubmissions = submissions.filter(sub => sub.type === 'test-drive');
            
            // 更新今日賞車預約計數（排除已完成項目）
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = testDriveSubmissions.filter(sub => sub.date === today && sub.status !== 'completed');
            updateTodayTestDriveCount(todayAppointments.length);
            
            if (testDriveSubmissions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">暫無賞車預約記錄</td></tr>';
                return;
            }
            
            // 按日期和時間排序（從早到晚）——若缺少 date/time 則回退到 timestamp
            function parseSubmissionTime(s) {
                const d = s.date || s.selectedDate || '';
                const t = s.time || s.selectedTime || '';
                const dt = new Date(`${d} ${t}`);
                if (!isNaN(dt.getTime())) return dt.getTime();
                if (s.timestamp) return new Date(s.timestamp).getTime();
                return 0;
            }
            testDriveSubmissions.sort((a, b) => parseSubmissionTime(a) - parseSubmissionTime(b));

            testDriveSubmissions.forEach((submission, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#TD${String(index + 1).padStart(4, '0')}</td>
                    <td>${submission.name || ''}</td>
                    <td>${submission.phone || ''}</td>
                    <td>${submission.date || ''} ${submission.time || ''}</td>
                    <td>${submission.brand ? submission.brand : ''} / ${submission.model ? submission.model : ''}</td>
                    <td>${submission.notes || ''}</td>
                    <td><span class="status-badge status-${submission.status || 'pending'}">${getStatusText(submission.status)}</span></td>
                    <td>
                        <button class="btn-edit" onclick="updateTestDriveStatus('${submission.id}', '${submission.status === 'completed' ? 'pending' : 'completed'}')">
                            ${submission.status === 'completed' ? '已完成' : '未完成'}
                        </button>
                        <button class="btn-delete" onclick="deleteTestDrive('${submission.id}')">刪除</button>
                    </td>
                    <td>
                        <input type="text" id="staffNote-${index}" class="staff-note-input" value="${submission.staffNote ? submission.staffNote.replace(/\"/g, '&quot;') : ''}" placeholder="人員備註" ${submission.staffNote ? 'disabled' : ''}>
                        <button class="btn-save-note" onclick="toggleStaffNote(${index}, this)">${submission.staffNote ? '編輯' : '儲存'}</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 載入並顯示活動報名數據
        function loadAndDisplayEvents() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#events-section tbody');
            
            if (!tableBody) {
                console.error('找不到活動報名表格主體元素');
                return;
            }
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            // 過濾出活動報名
            const eventSubmissions = submissions.filter(sub => sub.type === 'event');
            
            // 更新活動報名人數計數
            updateEventRegistrationCount(eventSubmissions.length);
            
            if (eventSubmissions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暫無活動報名記錄</td></tr>';
                return;
            }
            
            // 按活動日期排序（最近的排前面）
            eventSubmissions.sort((a, b) => {
                const dateA = new Date(a.eventDate);
                const dateB = new Date(b.eventDate);
                return dateA - dateB;
            });
            
            // 將活動分組
            const events = {};
            eventSubmissions.forEach(submission => {
                if (!events[submission.eventId]) {
                    events[submission.eventId] = {
                        name: submission.eventName,
                        date: submission.eventDate,
                        location: submission.eventLocation || '未指定',
                        maxParticipants: submission.maxParticipants || 100,
                        participants: []
                    };
                }
                events[submission.eventId].participants.push(submission);
            });
            
            // 顯示活動列表
            Object.values(events).forEach((event, index) => {
                const row = document.createElement('tr');
                const participantCount = event.participants.length;
                const isFull = participantCount >= event.maxParticipants;
                
                row.innerHTML = `
                    <td>${event.name || '未命名活動'}</td>
                    <td>${event.date || '未設定日期'}</td>
                    <td>${event.location}</td>
                    <td>${participantCount}/${event.maxParticipants}</td>
                    <td><span style="color: ${isFull ? 'var(--danger-color)' : 'var(--success-color)'};">
                        ${isFull ? '已額滿' : '接受報名中'}
                    </span></td>
                    <td>
                        <button class="btn-edit" onclick="viewEventParticipants('${event.name}')">
                            查看名單 (${participantCount})
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 更新今日賞車預約計數
        function updateTodayTestDriveCount(count) {
            const todayTestDrivesElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (todayTestDrivesElement) {
                todayTestDrivesElement.textContent = count;
                todayTestDrivesElement.nextElementSibling.textContent = count > 0 ? `今日有 ${count} 筆預約` : '尚無資料';
            }
        }

        function updateInventoryCount() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const inventoryCount = submissions.filter(s => s && s.type === 'inventory').length;
            const elem = document.querySelector('.stat-card:nth-child(4) .stat-number');
            if (elem) {
                elem.textContent = inventoryCount;
                elem.nextElementSibling.textContent = inventoryCount > 0 ? `${inventoryCount} 台現車` : '尚無資料';
            }
        }

        function updateAllStats() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            // 保養今日
            const maintenance = submissions.filter(s => s && s.type === 'maintenance');
            const today = new Date().toISOString().split('T')[0];
            // 排除已完成的保養預約
            const maintenanceToday = maintenance.filter(m => m.date === today && m.status !== 'completed').length;
            updateTodayAppointmentCount(maintenanceToday);

            // 賞車今日（排除已完成）
            const testdrives = submissions.filter(s => s && s.type === 'test-drive');
            const testdriveToday = testdrives.filter(t => t.date === today && t.status !== 'completed').length;
            updateTodayTestDriveCount(testdriveToday);

            // 活動（數量）
            const events = submissions.filter(s => s && s.type === 'event');
            updateEventRegistrationCount(events.length);

            // 庫存
            updateInventoryCount();

            // 更新業績統計
            if (typeof updateRevenueStats === 'function') updateRevenueStats();
        }

        // 計算並更新業績（僅計算已完成的保養/服務項目）
        // mode: undefined -> 更新今日與本月; 'today' -> 只更新今日; 'month' -> 只更新本月
        function updateRevenueStats(mode, filter) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const revenueTypes = ['maintenance', 'service'];
            const now = new Date();
            let todayStr = new Date().toISOString().split('T')[0];
            let month = now.getMonth();
            let year = now.getFullYear();
            // 如果有傳入 filter，根據 mode 解析
            if (filter) {
                if (mode === 'today') {
                    // filter 應為 YYYY-MM-DD
                    todayStr = filter;
                } else if (mode === 'month') {
                    // filter 應為 YYYY-MM
                    const parts = String(filter).split('-');
                    if (parts.length === 2) {
                        year = Number(parts[0]) || year;
                        month = (Number(parts[1]) - 1) || month;
                    }
                }
            }

            let todaySum = 0;
            let monthSum = 0;
            const recentToday = [];
            const recentMonth = [];

            submissions.forEach(s => {
                if (!s) return;
                if (!revenueTypes.includes(s.type)) return;
                if (s.status !== 'completed') return;

                let priceVal = 0;
                if (s.price !== undefined && s.price !== null && s.price !== '') {
                    priceVal = Number(String(s.price).replace(/[^0-9.-]+/g, '')) || 0;
                } else if (s.amount !== undefined) {
                    priceVal = Number(String(s.amount).replace(/[^0-9.-]+/g, '')) || 0;
                }

                let dateStr = s.date || null;
                if (!dateStr && s.completedAt) dateStr = s.completedAt.split('T')[0];

                if (dateStr) {
                    const d = new Date(dateStr);
                    if (d.toISOString().split('T')[0] === todayStr) {
                        todaySum += priceVal;
                        recentToday.push({ date: dateStr, name: s.name || '', item: s.serviceType || s.service || '', price: priceVal });
                    }
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        monthSum += priceVal;
                        recentMonth.push({ date: dateStr, name: s.name || '', item: s.serviceType || s.service || '', price: priceVal });
                    }
                }
            });

            // 更新今日
            if (!mode || mode === 'today') {
                const todayElem = document.getElementById('sales-today-amount');
                const todayNote = document.getElementById('sales-today-note');
                if (todayElem) todayElem.textContent = formatCurrency(todaySum);
                if (todayNote) todayNote.textContent = '已完成項目（今日）';
                const tbodyToday = document.querySelector('#sales-today-table tbody');
                if (tbodyToday) {
                    tbodyToday.innerHTML = '';
                    recentToday.sort((a, b) => new Date(b.date) - new Date(a.date));
                    recentToday.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r.date || '--'}</td><td>${r.name}</td><td>${r.item}</td><td>${formatCurrency(r.price)}</td>`;
                        tbodyToday.appendChild(tr);
                    });
                }
            }

            // 更新本月
            if (!mode || mode === 'month') {
                const monthElem = document.getElementById('sales-month-amount');
                const monthNote = document.getElementById('sales-month-note');
                if (monthElem) monthElem.textContent = formatCurrency(monthSum);
                if (monthNote) monthNote.textContent = '已完成項目（本月）';
                const tbodyMonth = document.querySelector('#sales-month-table tbody');
                if (tbodyMonth) {
                    tbodyMonth.innerHTML = '';
                    recentMonth.sort((a, b) => new Date(b.date) - new Date(a.date));
                    recentMonth.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r.date || '--'}</td><td>${r.name}</td><td>${r.item}</td><td>${formatCurrency(r.price)}</td>`;
                        tbodyMonth.appendChild(tr);
                    });
                }
            }
        }

        function formatCurrency(n) {
            return Number(n || 0).toLocaleString('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });
        }
        
        // 更新活動報名人數計數
        function updateEventRegistrationCount(count) {
            const eventRegistrationsElement = document.querySelector('.stat-card:nth-child(3) .stat-number');
            if (eventRegistrationsElement) {
                eventRegistrationsElement.textContent = count;
                eventRegistrationsElement.nextElementSibling.textContent = count > 0 ? `${count} 人已報名` : '尚無報名';
            }
        }
        
        // 更新賞車預約狀態
        function updateTestDriveStatus(submissionId, status) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const mainIndex = submissions.findIndex(s => s && s.id == submissionId && s.type === 'test-drive');
            if (mainIndex !== -1) {
                submissions[mainIndex].status = status;
                if (status === 'completed') submissions[mainIndex].completedAt = new Date().toISOString();
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                loadAndDisplayTestDrives();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        }
        
        // 刪除賞車預約
        function deleteTestDrive(submissionId) {
            if (!confirm('確定要刪除此筆賞車預約嗎？')) return;
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const updatedSubmissions = submissions.filter(s => s.id != submissionId);
            localStorage.setItem('formSubmissions', JSON.stringify(updatedSubmissions));
            loadAndDisplayTestDrives();
            if (typeof updateAllStats === 'function') updateAllStats();
        }

        // 切換/儲存人員備註：若輸入框已鎖定（disabled），點按將解鎖進入編輯；若未鎖定，則儲存並鎖定
        function toggleStaffNote(index, btn) {
            const input = document.getElementById(`staffNote-${index}`);
            if (!input) return;

            // 如果目前是鎖定狀態，切換為可編輯
            if (input.disabled) {
                input.disabled = false;
                input.focus();
                btn.textContent = '儲存';
                return;
            }

            // 否則進行儲存並鎖定
            const note = input.value;
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const testDriveSubmissions = submissions.filter(sub => sub.type === 'test-drive');
            if (!testDriveSubmissions[index]) return;

            const submissionId = testDriveSubmissions[index].id;
            const mainIndex = submissions.findIndex(s => s.id === submissionId);
            if (mainIndex === -1) return;

            submissions[mainIndex].staffNote = note;
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));

            // 更新 UI：鎖定輸入並把按鈕改為編輯
            input.disabled = true;
            btn.textContent = '編輯';
            if (window.Utils && typeof Utils.showToast === 'function') {
                Utils.showToast('人員備註已儲存', 'success');
            }
            // 若需要更確實的重繪，可重新載入列表
            // loadAndDisplayTestDrives();
        }
        
        // 查看活動參與者
        function viewEventParticipants(eventName) {
            alert(`查看 ${eventName} 的參與者名單功能將在後續版本中提供。`);
        }
        
        // 獲取服務類型文字
        function getServiceTypeText(type) {
            const types = {
                'check_condition': '車況檢查',
                'oil': '機油更換',
                'major': '大保養',
                'inspection': '年度健檢',
                'tires': '輪胎更換',
                'brakes': '煞車系統',
                'chain': '鏈條保養',
                'accident': '事故維修',
                'engine': '引擎檢查',
                'other': '其他'
            };
            return types[type] || type;
        }
        
        // 更新今日預約保養計數
        function updateTodayAppointmentCount(count) {
            const todayAppointmentsElement = document.querySelector('.stat-card:nth-child(1) .stat-number');
            if (todayAppointmentsElement) {
                todayAppointmentsElement.textContent = count;
                todayAppointmentsElement.nextElementSibling.textContent = count > 0 ? `今日有 ${count} 筆預約` : '尚無資料';
            }
        }
        
        // 獲取狀態文字
        function getStatusText(status) {
            const statusMap = {
                'pending': '未處理',
                'completed': '處理完成'
            };
            return statusMap[status] || '未處理';
        }
        
        // 更新狀態
        function updateStatus(index, status) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            if (submissions[index]) {
                submissions[index].status = status;
                // 如果是完成狀態，添加完成時間
                if (status === 'completed') {
                    submissions[index].completedAt = new Date().toISOString();
                }
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                loadAndDisplayMaintenance();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        }
        
        // 刪除預約
        function deleteSubmission(index) {
            if (confirm('確定要刪除此筆預約嗎？')) {
                const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                submissions.splice(index, 1);
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                loadAndDisplayMaintenance();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        }

        // 載入並顯示表單提交數據
        function loadAndDisplaySubmissions() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#maintenance-table tbody');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            submissions.forEach((submission, index) => {
                if (submission.type === 'maintenance') {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${submission.name || ''}</td>
                        <td>${submission.phone || ''}</td>
                        <td>${submission.bikeModel || ''}</td>
                        <td>${getServiceTypeText(submission.serviceType)}</td>
                        <td>${submission.date || ''} ${submission.time || ''}</td>
                        <td>${submission.notes || ''}</td>
                        <td>
                            <div class="price-edit" data-id="${submission.id}">
                                <input type="text" class="price-input" value="${submission.price || ''}" placeholder="輸入價格" 
                                       onchange="updatePrice('${submission.id}', this.value)" 
                                       style="width: 80px; text-align: right;">
                                <span>元</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${submission.status === 'completed' ? 'status-completed' : 'status-pending'}">
                                ${submission.status === 'completed' ? '已完成' : '未處理'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-edit" onclick="updateStatus('${submission.id}', '${submission.status === 'completed' ? 'pending' : 'completed'}')">
                                ${submission.status === 'completed' ? '未完成' : '標記完成'}
                            </button>
                            <button class="btn-delete" onclick="deleteSubmission('${submission.id}')">刪除</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // 獲取服務類型文字
        function getServiceTypeText(type) {
            const types = {
                'check_condition': '車況檢查',
                'oil': '機油更換',
                'major': '大保養',
                'inspection': '年度健檢',
                'tires': '輪胎更換',
                'brakes': '煞車系統',
                'chain': '鏈條保養',
                'accident': '事故維修',
                'engine': '引擎檢查',
                'other': '其他'
            };
            return types[type] || type;
        }

        // 更新價格
        function updatePrice(submissionId, newPrice) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const submission = submissions.find(s => s.id === submissionId);
            
            if (submission) {
                // 移除非數字字符，只保留數字和小數點
                const numericValue = newPrice.replace(/[^\d.]/g, '');
                submission.price = numericValue;
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                
                // 重新載入數據以更新顯示
                loadAndDisplayMaintenance();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        }

        // 更新狀態
        function updateStatus(submissionId, status) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const submission = submissions.find(s => s.id === submissionId);
            
            if (submission) {
                submission.status = status;
                if (status === 'completed') {
                    submission.completedAt = new Date().toISOString();
                }
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                loadAndDisplayMaintenance();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        }

        // 刪除預約
        function deleteSubmission(submissionId) {
            if (confirm('確定要刪除此筆預約嗎？')) {
                const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                const updatedSubmissions = submissions.filter(s => s.id !== submissionId);
                localStorage.setItem('formSubmissions', JSON.stringify(updatedSubmissions));
                loadAndDisplayMaintenance();
                if (typeof updateAllStats === 'function') updateAllStats();
            }
        }
        
        // 表單類型對應的中文名稱
        const formTypeNames = {
            'test-drive': '預約試乘',
            'service': '保養預約',
            'event': '活動報名'
        };
        
        // 表單類型對應的標籤頁ID
        const formTypeToTab = {
            'test-drive': 'test-drive',
            'service': 'maintenance',
            'event': 'events'
        };

        // 表單模板
        const formTemplates = {
            maintenance: {
                title: '預約保養',
                fields: [
                    { type: 'text', id: 'customerName', label: '客戶姓名', required: true },
                    { type: 'tel', id: 'phone', label: '聯絡電話', required: true },
                    { type: 'date', id: 'appointmentDate', label: '預約日期', required: true },
                    { type: 'time', id: 'appointmentTime', label: '預約時間', required: true },
                    { type: 'select', id: 'serviceType', label: '服務類型', options: ['定期保養', '一般維修', '事故維修', '其他'], required: true },
                    { type: 'textarea', id: 'notes', label: '備註' }
                ]
            },
            testDrive: {
                title: '預約試乘',
                fields: [
                    { type: 'text', id: 'customerName', label: '客戶姓名', required: true },
                    { type: 'tel', id: 'phone', label: '聯絡電話', required: true },
                    { type: 'email', id: 'email', label: '電子郵件' },
                    { type: 'date', id: 'preferredDate', label: '預約日期', required: true },
                    { type: 'select', id: 'preferredTime', label: '預約時段', 
                      options: ['09:00-10:00', '10:00-11:00', '11:00-12:00', '13:00-14:00', '14:00-15:00', '15:00-16:00'], 
                      required: true },
                    { type: 'select', id: 'carModel', label: '車型', 
                      options: ['NINJA ZX-10R', 'NINJA ZX-6R', 'Z H2', 'NINJA H2', 'VERSYS 1000', 'Z650'], 
                      required: true }
                ]
            },
            event: {
                title: '活動報名',
                fields: [
                    { type: 'text', id: 'eventName', label: '活動名稱', required: true },
                    { type: 'date', id: 'eventDate', label: '活動日期', required: true },
                    { type: 'number', id: 'maxParticipants', label: '人數上限', min: 1, required: true },
                    { type: 'textarea', id: 'description', label: '活動說明', required: true }
                ]
            },
            inventory: {
                title: '車輛庫存',
                fields: [
                    { type: 'text', id: 'model', label: '車型', required: true },
                    { type: 'text', id: 'color', label: '顏色', required: true },
                    { type: 'number', id: 'year', label: '年份', min: 1900, max: new Date().getFullYear() + 1, required: true },
                    { type: 'number', id: 'mileage', label: '里程數 (km)', min: 0, step: 1 },
                    { type: 'number', id: 'price', label: '售價', min: 0, step: 100, required: true },
                    { type: 'number', id: 'stock', label: '庫存數量', min: 0 },
                    { type: 'text', id: 'vin', label: '車身號碼 (VIN)' },
                    { type: 'file', id: 'image', label: '車輛圖片', accept: 'image/*' }
                ]
            }
        };

        // 避免重複初始化
        let isInitialized = false;
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (!isInitialized) {
                initTabs();
                initModals();
                initButtons();
                showTab('dashboard');
                isInitialized = true;
            }
        });

        // 初始化標籤頁切換
        function initTabs() {
            // 先移除所有現有的事件監聽器
            document.querySelectorAll('.menu-item[data-tab]').forEach(item => {
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });
            
            // 添加新的事件監聽器
            document.querySelectorAll('.menu-item[data-tab]').forEach(item => {
                item.addEventListener('click', handleTabClick);
            });

            // 檢查URL的hash來決定顯示哪個頁面
            function checkHash() {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const tabElement = document.querySelector(`.menu-item[data-tab="${hash}"]`);
                    if (tabElement) {
                        showTab(hash);
                        return;
                    }
                }
                // 如果沒有匹配的hash或hash為空，顯示儀表板
                showTab('dashboard');
            }
            
            // 處理標籤點擊
            function handleTabClick(e) {
                e.preventDefault();
                const tabId = this.getAttribute('data-tab');
                showTab(tabId);
            }

            // 監聽hash變化
            window.addEventListener('hashchange', checkHash, { once: true });
            
            // 頁面載入時檢查hash
            checkHash();
        }

        // 切換標籤頁
        function showTab(tabId, event) {
            if (event) {
                event.preventDefault();
            }
            
            // 更新當前標籤
            currentTab = tabId;
            
            // 更新選單項目的active類
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 找到對應的選單項目並添加active類
            const menuItem = document.querySelector(`.menu-item[data-tab="${tabId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
            
            // 隱藏所有內容區塊
            document.querySelectorAll('.card').forEach(card => {
                card.style.display = 'none';
            });
            
            // 顯示當前選中的內容區塊
            const targetSection = document.getElementById(tabId + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // 根據當前標籤載入對應的數據
                loadTabData(tabId);
                
                // 滾動到頂部
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // 更新頁面標題
                let pageTitle = menuItem ? menuItem.textContent.trim() : tabId;
                // 特別處理各標題
                if (tabId === 'maintenance') {
                    pageTitle = '預約保養管理';
                } else if (tabId === 'test-drive') {
                    pageTitle = '預約管理';
                } else if (tabId === 'events') {
                    pageTitle = '活動報名管理';
                } else if (tabId === 'inventory') {
                    pageTitle = '現車庫存管理';
                } else if (tabId === 'sales-today') {
                    pageTitle = '今日業績';
                } else if (tabId === 'sales-month') {
                    pageTitle = '本月業績';
                }
                const pageHeader = document.querySelector('.page-header h1');
                if (pageHeader) {
                    pageHeader.innerHTML = `<i class="fas ${getTabIcon(tabId)}"></i> ${pageTitle}`;
                }
                
                // 更新URL的hash
                window.location.hash = tabId;
                
                // 更新麵包屑
                const breadcrumb = document.querySelector('.breadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = `
                        <a href="#" onclick="showTab('dashboard', event); return false;">首頁</a> /
                        <span>${pageTitle}</span>
                    `;
                }
            }
        }
        
        // 獲取標籤頁圖標
        function getTabIcon(tabId) {
            const icons = {
                'dashboard': 'fa-tachometer-alt',
                'maintenance': 'fa-tools',
                'test-drive': 'fa-car',
                'events': 'fa-calendar-alt',
                'inventory': 'fa-warehouse',
                'settings': 'fa-cog',
                'logout': 'fa-sign-out-alt'
            };
            return icons[tabId] || 'fa-folder';
        }

        // 初始化模態框
        function initModals() {
            // 關閉按鈕
            const closeBtn = document.getElementById('closeModal');
            if (closeBtn) closeBtn.addEventListener('click', closeModal);

            // 點擊模態框外部關閉
            const modalEl = document.getElementById('modal');
            if (modalEl) {
                modalEl.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal();
                    }
                });
            }

            // 阻止點擊模態框內容時關閉
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) modalContent.addEventListener('click', function(e) { e.stopPropagation(); });
        }
        
        // 初始化按鈕事件
        function initButtons() {
            // 新增按鈕（先檢查元素是否存在以避免初始化錯誤）
            const addMaintenanceBtn = document.getElementById('add-maintenance');
            if (addMaintenanceBtn) addMaintenanceBtn.addEventListener('click', () => openModal('maintenance'));
            const addTestDriveBtn = document.getElementById('add-test-drive');
            if (addTestDriveBtn) addTestDriveBtn.addEventListener('click', () => openModal('testDrive'));
            const addEventBtn = document.getElementById('add-event');
            if (addEventBtn) addEventBtn.addEventListener('click', () => openModal('event'));
            const addInventoryBtn = document.getElementById('add-inventory');
            if (addInventoryBtn) addInventoryBtn.addEventListener('click', () => openModal('inventory'));
            
            // 導航按鈕
            document.querySelector('.admin-logo').addEventListener('click', (e) => {
                e.preventDefault();
                showTab('dashboard');
            });
            
            // 登出按鈕
            document.querySelectorAll('.menu-item').forEach(item => {
                if (item.querySelector('.fa-sign-out-alt')) {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('確定要登出系統嗎？')) {
                            window.location.href = 'login.html';
                        }
                    });
                } else if (item.getAttribute('data-tab') === 'settings') {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        alert('系統設定功能開發中');
                    });
                }
            });
            
            // 返回官網按鈕
            document.querySelector('.btn-outline').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = '../index.html';
            });
        }
        
        // 打開編輯模態框
        function openModalForEdit(type, item) {
            currentModal = type;
            const modal = document.getElementById('modal');
            const template = formTemplates[type];
            
            if (!template) return;
            
            // 設置標題
            document.getElementById('modalTitle').textContent = `編輯${template.title}`;
            
            // 生成表單並填充數據
            let formHTML = `
                <form id="${type}Form" class="modal-form">
                    <input type="hidden" name="id" value="${item.id || ''}">
                    <div class="form-grid">
            `;
            
            template.fields.forEach(field => {
                const value = item[field.id] || '';
                const required = field.required ? 'required' : '';
                let inputHTML = '';
                
                switch(field.type) {
                    case 'select':
                        inputHTML = `
                            <select id="${field.id}" name="${field.id}" class="form-control" ${required}>
                                <option value="">請選擇</option>
                                ${field.options.map(opt => 
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                        break;
                        
                    case 'textarea':
                        inputHTML = `<textarea id="${field.id}" name="${field.id}" class="form-control" rows="3" ${required}>${value}</textarea>`;
                        break;
                        
                    default:
                        const min = field.min !== undefined ? `min="${field.min}"` : '';
                        const max = field.max !== undefined ? `max="${field.max}"` : '';
                        const step = field.step !== undefined ? `step="${field.step}"` : '';
                        const accept = field.accept ? `accept="${field.accept}"` : '';
                        inputHTML = `<input type="${field.type}" id="${field.id}" name="${field.id}" class="form-control" value="${value}" ${required} ${min} ${max} ${step} ${accept}>`;
                }
                
                formHTML += `
                    <div class="form-group">
                        <label for="${field.id}">${field.label}${field.required ? ' <span class="required">*</span>' : ''}</label>
                        ${inputHTML}
                    </div>
                `;
            });
            
            formHTML += `
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">更新</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formContent').innerHTML = formHTML;
            
            // 添加表單提交事件
            document.getElementById(`${type}Form`).addEventListener('submit', handleFormSubmit);
            
            // 顯示模態框
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 打開新增模態框
        function openModal(type) {
            currentModal = type;
            const modal = document.getElementById('modal');
            const template = formTemplates[type];
            
            if (!template) return;
            
            // 設置標題
            document.getElementById('modalTitle').textContent = `新增${template.title}`;
            
            // 生成表單
            let formHTML = `
                <form id="${type}Form" class="modal-form">
                    <div class="form-grid">
            `;
            
            template.fields.forEach(field => {
                const required = field.required ? 'required' : '';
                let inputHTML = '';
                
                switch(field.type) {
                    case 'select':
                        inputHTML = `
                            <select id="${field.id}" name="${field.id}" class="form-control" ${required}>
                                <option value="">請選擇</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `;
                        break;
                        
                    case 'textarea':
                        inputHTML = `<textarea id="${field.id}" name="${field.id}" class="form-control" rows="3" ${required}></textarea>`;
                        break;
                        
                    default:
                        const min = field.min !== undefined ? `min="${field.min}"` : '';
                        const max = field.max !== undefined ? `max="${field.max}"` : '';
                        const step = field.step !== undefined ? `step="${field.step}"` : '';
                        const accept = field.accept ? `accept="${field.accept}"` : '';
                        inputHTML = `<input type="${field.type}" id="${field.id}" name="${field.id}" class="form-control" ${required} ${min} ${max} ${step} ${accept}>`;
                }
                
                formHTML += `
                    <div class="form-group">
                        <label for="${field.id}">${field.label}${field.required ? ' <span class="required">*</span>' : ''}</label>
                        ${inputHTML}
                    </div>
                `;
            });
            
            formHTML += `
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formContent').innerHTML = formHTML;
            
            // 添加表單提交事件
            document.getElementById(`${type}Form`).addEventListener('submit', handleFormSubmit);
            
            // 顯示模態框
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 關閉模態框
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('formContent').innerHTML = '';
            }, 300);
        }
        
        // 處理表單提交
        function handleFormSubmit(e) {
            e.preventDefault();
            
            // 獲取表單數據
            const form = e.target;
            const formData = new FormData(form);
            const formValues = {};
            
            for (let [key, value] of formData.entries()) {
                formValues[key] = value;
            }
            
            // 獲取當前表單類型
            const formType = currentModal;

            // 對 inventory 表單的數值欄位做型別轉換
            if (formType === 'inventory') {
                if (formValues.price) formValues.price = Number(formValues.price);
                if (formValues.year) formValues.year = Number(formValues.year);
                if (formValues.mileage) formValues.mileage = Number(formValues.mileage);
                if (formValues.stock) formValues.stock = Number(formValues.stock);
            }
            
            // 從本地存儲獲取現有數據
            let submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            
            if (formValues.id) {
                // 更新現有項目
                const index = submissions.findIndex(item => {
                    const itemId = String(item.id || '');
                    const formId = String(formValues.id || '');
                    return itemId === formId;
                });
                
                if (index !== -1) {
                    // 更新現有項目
                    submissions[index] = {
                        ...submissions[index],
                        ...formValues,
                        id: submissions[index].id, // 保持原ID不變
                        type: formType === 'maintenance' ? 'service' : 
                              formType === 'events' ? 'event' : formType,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // 添加新項目
                const newItem = {
                    ...formValues,
                    id: Date.now(),
                    type: formType === 'maintenance' ? 'service' : 
                          formType === 'events' ? 'event' : formType,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                submissions.push(newItem);
            }
            
            // 保存到本地存儲
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));
            
            // 關閉模態框
            closeModal();
            
            // 刷新當前標籤頁的數據
            loadTabData(currentTab);
            
            // 顯示成功消息
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.textContent = formValues.id ? '更新成功！' : '新增成功！';
            document.body.appendChild(toast);
            
            // 3秒後移除提示
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // 編輯項目
        function editItem(type, id) {
            // 從本地存儲中獲取數據
            const savedData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            
            // 查找要編輯的項目
            const itemToEdit = savedData.find(item => {
                const itemType = item.type || '';
                const itemId = String(item.id || '');
                const targetId = String(id || '');
                
                if (type === 'maintenance' && itemType === 'service') {
                    return itemId === targetId;
                } else if (type === 'events' && itemType === 'event') {
                    return itemId === targetId;
                } else {
                    return itemType === type && itemId === targetId;
                }
            });
            
            if (itemToEdit) {
                // 填充表單並打開編輯模態框
                openModalForEdit(type, itemToEdit);
            } else {
                alert('找不到要編輯的項目');
            }
        }
        
        // 如果沒有找到數據，使用模擬數據（僅在第一次加載時）
        if (tabData.length === 0 && !localStorage.getItem('initialDataLoaded')) {
            tabData = getMockData(tabId);
            // 保存模擬數據到 localStorage
            const existingData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const newData = [...existingData, ...tabData];
            localStorage.setItem('formSubmissions', JSON.stringify(newData));
        }
            localStorage.setItem('initialDataLoaded', 'true');
        function loadTabData(tabId) {
            // 清空現有數據
            const tableBody = document.querySelector(`#${tabId}-section tbody`);
            if (tableBody) {
                tableBody.innerHTML = '';
                
                // 從 localStorage 獲取數據
                let tabData = [];
                const savedData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                
                if (savedData && savedData.length > 0) {
                    // 過濾出當前標籤頁的數據
                    if (tabId === 'test-drive') {
                        tabData = savedData.filter(item => item.type === 'test-drive');
                    } else if (tabId === 'maintenance') {
                        tabData = savedData.filter(item => item.type === 'service');
                    } else if (tabId === 'events') {
                        tabData = savedData.filter(item => item.type === 'event');
                    } else {
                        tabData = savedData.filter(item => item.type === tabId);
                    }
                }
                
                // 如果沒有找到數據，使用模擬數據（僅在第一次加載時）
                if (tabData.length === 0 && !localStorage.getItem('initialDataLoaded')) {
                    tabData = getMockData(tabId);
                    // 保存模擬數據到 localStorage
                    const existingData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                    const newData = [...existingData, ...tabData];
                    localStorage.setItem('formSubmissions', JSON.stringify(newData));
                    localStorage.setItem('initialDataLoaded', 'true');
                    
                    // 重新加載數據
                    return loadTabData(tabId);
                }
                
                // 排序數據，最新的在前面
                tabData.sort((a, b) => {
                    const dateA = new Date(a.date || a.createdAt || 0);
                    const dateB = new Date(b.date || b.createdAt || 0);
                    return dateB - dateA;
                });
                
                // 渲染數據到表格
                if (tabData && tabData.length > 0) {
                    tabData.forEach(item => {
                        const row = document.createElement('tr');
                        const itemType = item.type === 'service' ? 'maintenance' : 
                                       item.type === 'event' ? 'events' : item.type;
                        row.setAttribute('data-type', itemType);
                        row.setAttribute('data-id', item.id);
                        row.innerHTML = generateTableRow(tabId, item);
                        tableBody.appendChild(row);
                    });
                } else {
                    // 如果沒有數據，顯示提示信息
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = '10';
                    cell.className = 'text-center py-4 text-muted';
                    cell.textContent = '沒有找到相關數據';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            }
        }
        
        
        
        // 生成表格行
        function generateTableRow(tabId, item) {
            // 根據表單類型顯示不同的欄位
            const formType = item.type || tabId;
            
            // 格式化日期
            const formatDate = (dateString) => {
                if (!dateString) return '--';
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            // 根據表單類型生成對應的行
            switch(formType) {
                case 'test-drive':
                    return `
                        <td>${item.name || '--'}</td>
                        <td>${item.phone || '--'}</td>
                        <td>${item.brand || '--'}</td>
                        <td>${item.model || '--'}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'pending')}">
                                ${getStatusText(item.status || 'pending')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('test-drive', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="if(confirm('確定要刪除此項目嗎？')) { deleteItem('test-drive', '${item.id}'); }" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                case 'service':
                    return `
                        <td>${item.name || '--'}</td>
                        <td>${item.phone || '--'}</td>
                        <td>${item.vehicleBrand || '--'}</td>
                        <td>${item.vehicleModel || '--'}</td>
                        <td>${item.serviceType || '--'}</td>
                        <td>${formatDate(item.appointmentDate)} ${item.appointmentTime || ''}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'pending')}">
                                ${getStatusText(item.status || 'pending')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('maintenance', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="if(confirm('確定要刪除此項目嗎？')) { deleteItem('maintenance', '${item.id}'); }" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                case 'event':
                    return `
                        <td>${item.eventName || '--'}</td>
                        <td>${item.name || '--'}</td>
                        <td>${item.phone || '--'}</td>
                        <td>${item.email || '--'}</td>
                        <td>${item.participants || '1'} 人</td>
                        <td>${formatDate(item.createdAt || item.date)}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'pending')}">
                                ${getStatusText(item.status || 'pending')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('events', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="if(confirm('確定要刪除此項目嗎？')) { deleteItem('events', '${item.id}'); }" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                case 'inventory':
                    return `
                        <td>${item.licensePlate || '--'}</td>
                        <td>${item.model || '--'}</td>
                        <td>${item.color || '--'}</td>
                        <td>${item.year || '--'}</td>
                        <td>${item.mileage ? `${item.mileage.toLocaleString()} km` : '--'}</td>
                        <td>${item.price ? `$${item.price.toLocaleString()}` : '--'}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'available')}">
                                ${getStatusText(item.status || 'available')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('${tabId}', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="if(confirm('確定要刪除此項目嗎？')) { deleteItem('${tabId}', '${item.id}'); }" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                case 'maintenance':
                    return `
                        <td>${item.name}</td>
                        <td>${item.phone}</td>
                        <td>${item.date} ${item.time}</td>
                        <td>${item.serviceType}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit" onclick="editItem('${tabId}', ${item.id})">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deleteItem('${tabId}', ${item.id})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </td>
                    `;
                case 'events':
                    const progress = Math.min(100, Math.round((item.participants / item.maxParticipants) * 100));
                    return `
                        <td>${item.eventName}</td>
                        <td>${item.date}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <span>${item.participants} / ${item.maxParticipants} 人</span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit" onclick="editItem('${tabId}', ${item.id})">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deleteItem('${tabId}', ${item.id})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </td>
                    `;
                case 'inventory':
                    return `
                        <td>${item.model}</td>
                        <td>${item.year}</td>
                        <td>${item.color}</td>
                        <td>$${item.price.toLocaleString()}</td>
                        <td>${item.stock}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit" onclick="editItem('${tabId}', ${item.id})">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deleteItem('${tabId}', ${item.id})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </td>
                    `;
                default:
                    return '';
            }
        }  // 新增保養預約
        document.getElementById('add-maintenance').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '新增保養預約';
            document.getElementById('formContent').innerHTML = `
                <form id="maintenanceForm" onsubmit="saveMaintenance(event)">
                    <div class="form-group">
                        <label for="customerName">客戶姓名</label>
                        <input type="text" id="customerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">聯絡電話</label>
                        <input type="tel" id="phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="appointmentDate">預約日期時間</label>
                        <input type="datetime-local" id="appointmentDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="carModel">車型</label>
                        <input type="text" id="carModel" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="licensePlate">車牌號碼</label>
                        <input type="text" id="licensePlate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">備註</label>
                        <textarea id="notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        });

        // 新增賞車預約
        document.getElementById('add-test-drive').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '新增賞車預約';
            document.getElementById('formContent').innerHTML = `
                <form id="testDriveForm" onsubmit="saveTestDrive(event)">
                    <div class="form-group">
                        <label for="tdCustomerName">客戶姓名</label>
                        <input type="text" id="tdCustomerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="tdPhone">聯絡電話</label>
                        <input type="tel" id="tdPhone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="tdDate">預約日期時間</label>
                        <input type="datetime-local" id="tdDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="interstedModel">感興趣車型</label>
                        <select id="interstedModel" class="form-control" required>
                            <option value="">-- 請選擇車型 --</option>
                            <option value="Model S">Model S</option>
                            <option value="Model 3">Model 3</option>
                            <option value="Model X">Model X</option>
                            <option value="Model Y">Model Y</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="salesPerson">業務人員</label>
                        <input type="text" id="salesPerson" class="form-control" required>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        });

        // 新增活動
        document.getElementById('add-event').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '新增活動';
            document.getElementById('formContent').innerHTML = `
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <div class="form-group">
                        <label for="eventName">活動名稱</label>
                        <input type="text" id="eventName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDate">活動日期時間</label>
                        <input type="datetime-local" id="eventDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="location">活動地點</label>
                        <input type="text" id="location" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="maxAttendees">最大參加人數</label>
                        <input type="number" id="maxAttendees" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">活動說明</label>
                        <textarea id="eventDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        });

        // 使用通用模態表單模板處理新增/編輯行為，inventory 表單由 `openModal('inventory')` 處理

        // 表單提交處理函數
        function saveMaintenance(e) {
            e.preventDefault();
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('phone').value;
            const appointment = document.getElementById('appointmentDate').value; // datetime-local
            const carModel = document.getElementById('carModel').value;
            const licensePlate = document.getElementById('licensePlate').value;
            const notes = document.getElementById('notes').value || '';

            const date = appointment ? appointment.split('T')[0] : '';
            const time = appointment ? appointment.split('T')[1].slice(0,5) : '';

            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const item = {
                id: Date.now(),
                type: 'maintenance',
                name: name,
                phone: phone,
                date: date,
                time: time,
                bikeModel: carModel,
                licensePlate: licensePlate,
                notes: notes,
                status: 'pending'
            };
            submissions.push(item);
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));
            loadAndDisplayMaintenance();
            if (typeof updateAllStats === 'function') updateAllStats();
            alert('保養預約已儲存');
            closeModal();
        }

        function saveTestDrive(e) {
            e.preventDefault();
            const name = document.getElementById('tdCustomerName').value;
            const phone = document.getElementById('tdPhone').value;
            const dt = document.getElementById('tdDate').value;
            const interested = document.getElementById('interstedModel').value;
            const salesPerson = document.getElementById('salesPerson').value || '';

            const date = dt ? dt.split('T')[0] : '';
            const time = dt ? dt.split('T')[1].slice(0,5) : '';

            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const item = {
                id: Date.now(),
                type: 'test-drive',
                name: name,
                phone: phone,
                date: date,
                time: time,
                brand: '',
                model: '',
                interestedModel: interested,
                salesPerson: salesPerson,
                notes: '',
                timestamp: new Date().toISOString(),
                status: 'pending'
            };
            submissions.push(item);
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));
            loadAndDisplayTestDrives();
            if (typeof updateAllStats === 'function') updateAllStats();
            alert('賞車預約已儲存');
            closeModal();
        }

        function saveEvent(e) {
            e.preventDefault();
            const name = document.getElementById('eventName').value;
            const dt = document.getElementById('eventDate').value;
            const location = document.getElementById('location').value;
            const max = document.getElementById('maxAttendees').value || 0;
            const description = document.getElementById('eventDescription').value || '';

            const item = {
                id: Date.now(),
                type: 'event',
                eventName: name,
                eventDate: dt,
                eventLocation: location,
                maxParticipants: Number(max),
                eventDescription: description
            };
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            submissions.push(item);
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));
            loadAndDisplayEvents();
            if (typeof updateAllStats === 'function') updateAllStats();
            alert('活動已建立');
            closeModal();
        }

        // inventory 表單由泛用的 handleFormSubmit 處理，資料會寫入 localStorage.formSubmissions
    </script>
    <!-- 引入行動選單 JavaScript -->
    <script src="../js/mobile-menu.js"></script>
</body>
</html>

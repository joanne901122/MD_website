<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台管理 | 明德車業 MINGDE MOTOR</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/mobile-menu.css" media="screen and (max-width: 992px)">
    <style>
        /* 覆蓋預設樣式以符合MD品牌 */
        :root {
            --kawa-green: var(--md-primary);
            --plaza-black: var(--md-text);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        /* 狀態標籤樣式 */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        /* 操作按鈕樣式 */
        .action-buttons {
            white-space: nowrap;
            text-align: center;
        }
        
        .btn-action {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
            margin: 0 2px;
        }
        
        .btn-action:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .btn-edit {
            color: #007bff;
        }
        
        .btn-edit:hover {
            color: #0056b3;
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .btn-delete {
            color: #dc3545;
        }
        
        .btn-delete:hover {
            color: #bd2130;
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        /* 提示消息樣式 */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-success {
            background-color: var(--success-color);
        }
        
        .toast-error {
            background-color: var(--danger-color);
        }
        
        .toast-warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        body {
            background-color: var(--md-light-gray);
            color: var(--md-text);
        }
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --light-gray: #f5f6fa;
            --dark-gray: #2d3436;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* 側邊欄樣式 */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .menu-item.active {
            background-color: var(--secondary-color);
            border-left: 4px solid white;
        }

        /* 主內容區 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        /* 表格樣式 */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        /* 按鈕樣式 */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* 表單樣式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- MD 管理後台頂部導航 -->
    <div class="admin-topbar">
        <div class="admin-topbar-content">
            <div class="admin-logo">
                <img src="../image/logo.jpg" alt="明德車業 Logo" class="logo-img">
                <span>明德車業 後台管理</span>
            </div>
            <div class="admin-user">
                <span class="admin-username"><i class="fas fa-user"></i> 管理員</span>
                <a href="../index.html" class="btn btn-sm btn-outline">返回官網</a>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- 側邊欄 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-bars"></i> 主選單</h3>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> 儀表板
                </li>
                <li class="menu-divider">車輛管理</li>
                <li class="menu-item" data-tab="inventory">
                    <i class="fas fa-warehouse"></i> 現車庫存管理
                </li>
                <li class="menu-divider">預約管理</li>
                <li class="menu-item" data-tab="test-drive">
                    <i class="fas fa-car"></i> 賞車預約
                </li>
                <li class="menu-item" data-tab="maintenance">
                    <i class="fas fa-tools"></i> 保養預約
                </li>
                <li class="menu-divider">活動管理</li>
                <li class="menu-item" data-tab="events">
                    <i class="fas fa-calendar-alt"></i> 活動報名
                </li>
                <li class="menu-divider">系統</li>
                <li class="menu-item">
                    <i class="fas fa-cog"></i> 系統設定
                </li>
                <li class="menu-item">
                    <i class="fas fa-sign-out-alt"></i> 登出系統
                </li>
            </ul>
        </div>

        <!-- 主內容區 -->
        <div class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-tachometer-alt"></i> 儀表板</h1>
                <div class="breadcrumb">
                    <a href="#">首頁</a> / <span>儀表板</span>
                </div>
            </div>

            <!-- 統計卡片 -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1);">
                        <i class="fas fa-wrench" style="color: #2ecc71;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>今日預約保養</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1);">
                        <i class="fas fa-car" style="color: #3498db;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>今日賞車預約</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1);">
                        <i class="fas fa-calendar-check" style="color: #9b59b6;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>活動報名人數</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1);">
                        <i class="fas fa-warehouse" style="color: #f1c40f;"></i>
                    </div>
                    <div class="stat-info">
                        <h3>現車庫存</h3>
                        <p class="stat-number">0</p>
                        <span class="stat-change">尚無資料</span>
                    </div>
                </div>
            </div>

            <!-- 預約保養管理 -->
            <div class="card" id="maintenance-section">
                <div class="card-header">
                    <span>預約保養管理</span>
                    <div>
                        <button class="btn btn-primary btn-sm" id="refresh-maintenance">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                        <button class="btn btn-primary btn-sm" id="add-maintenance">
                            <i class="fas fa-plus"></i> 新增預約
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table" id="maintenance-table">
                            <thead>
                                <tr>
                                    <th>預約時間</th>
                                    <th>姓名</th>
                                    <th>電話</th>
                                    <th>車型</th>
                                    <th>服務類型</th>
                                    <th>備註</th>
                                    <th>保養價錢</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 數據會在這裡動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 預約賞車管理 -->
            <div class="card" id="test-drive-section" style="display: none;">
                <div class="card-header">
                    <span>預約賞車管理</span>
                    <div>
                        <button class="btn btn-primary btn-sm" id="refresh-test-drive">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                        <button class="btn btn-primary btn-sm" id="add-test-drive">
                            <i class="fas fa-plus"></i> 新增預約
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table" id="test-drive-table">
                            <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>電話</th>
                                    <th>車型</th>
                                    <th>預約時間</th>
                                    <th>備註</th>
                                    <th style="width: 100px;">狀態</th>
                                    <th style="width: 300px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 數據會在這裡動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 活動報名管理 -->
            <div class="card" id="events-section" style="display: none;">
                <div class="card-header">
                    <span>活動報名管理</span>
                    <div>
                        <button class="btn btn-primary btn-sm" id="refresh-events">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                        <button class="btn btn-primary btn-sm" id="add-event">
                            <i class="fas fa-plus"></i> 新增活動
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>活動名稱</th>
                                    <th>活動日期</th>
                                    <th>地點</th>
                                    <th>報名人數</th>
                                    <th>報名狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024 新車發表會</td>
                                    <td>2024/01/15 14:00</td>
                                    <td>台北展示中心</td>
                                    <td>45/100</td>
                                    <td><span style="color: var(--success-color);">報名中</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm">名單</button>
                                        <button class="btn btn-primary btn-sm">編輯</button>
                                        <button class="btn btn-danger btn-sm">刪除</button>
                                    </td>
                                </tr>
                                <!-- 更多活動資料 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 現車庫存管理 -->
            <div class="card" id="inventory-section" style="display: none;">
                <div class="card-header">
                    <span>現車庫存管理</span>
                    <button class="btn btn-primary btn-sm" id="add-inventory">
                        <i class="fas fa-plus"></i> 新增車輛
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>車牌號碼</th>
                                    <th>車型</th>
                                    <th>顏色</th>
                                    <th>年份</th>
                                    <th>里程數</th>
                                    <th>售價</th>
                                    <th>庫存狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ABC-1234</td>
                                    <td>Model 3</td>
                                    <td>珍珠白</td>
                                    <td>2023</td>
                                    <td>1,234 公里</td>
                                    <td>1,650,000 元</td>
                                    <td><span style="color: var(--success-color);">在庫</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm">編輯</button>
                                        <button class="btn btn-danger btn-sm">刪除</button>
                                    </td>
                                </tr>
                                <!-- 更多庫存資料 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯表單模態框 -->
    <div class="modal" id="formModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                <h3 id="modalTitle">新增預約</h3>
                <button id="closeModal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" id="formContent">
                <!-- 表單內容將由JavaScript動態生成 -->
            </div>
        </div>
    </div>

    <style>
        /* 自定義樣式 */
        .admin-topbar {
            background: var(--md-white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .admin-topbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .admin-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-logo .logo-img {
            height: 40px;
            width: auto;
        }
        
        .admin-logo span {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--md-text);
        }
        
        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-username {
            color: var(--md-text);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--md-primary);
            color: var(--md-primary);
        }
        
        .btn-outline:hover {
            background: var(--md-primary);
            color: white;
        }
        
        .menu-divider {
            padding: 10px 25px;
            font-size: 0.85rem;
            color: var(--md-text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
        }
        
        .menu-divider:first-child {
            margin-top: 0;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            color: var(--md-text);
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .breadcrumb {
            color: var(--md-text-light);
            font-size: 0.9rem;
        }
        
        .breadcrumb a {
            color: var(--md-primary);
            text-decoration: none;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-info h3 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
            color: var(--md-text-light);
            font-weight: normal;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0 0 5px 0;
            color: var(--md-text);
        }
        
        .stat-change {
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .stat-change.up {
            color: var(--md-success);
        }
        
        .stat-change.down {
            color: var(--md-danger);
        }
    </style>
    
    <script>
        // 全局變量
        let currentTab = 'dashboard';
        let currentModal = null;
        
        // 從 localStorage 載入表單提交數據
        function loadFormSubmissions() {
            // 載入服務預約數據
            const serviceSubmissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const today = new Date().toISOString().split('T')[0];
            
            // 計算今日預約數量
            const todayAppointments = serviceSubmissions.filter(submission => {
                return submission.bookingDate && submission.bookingDate.startsWith(today);
            });
            
            // 更新統計卡片
            updateStatCard('maintenance', todayAppointments.length);
            
            // 更新預約表格
            updateAppointmentTable(serviceSubmissions);
        }
        
        // 更新統計卡片
        function updateStatCard(type, count) {
            if (type === 'maintenance') {
                const statNumber = document.querySelector('#maintenance-stat .stat-number');
                const statChange = document.querySelector('#maintenance-stat .stat-change');
                
                if (statNumber) statNumber.textContent = count;
                if (statChange) {
                    statChange.innerHTML = count > 0 ? 
                        '<i class="fas fa-arrow-up"></i> ' + count + ' 筆預約' : 
                        '尚無資料';
                    statChange.className = 'stat-change ' + (count > 0 ? 'up' : '');
                }
            }
        }
        
        // 更新預約表格
        function updateAppointmentTable(appointments) {
            const tbody = document.querySelector('#maintenance-table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appointments.forEach(appointment => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${appointment.id || ''}</td>
                    <td>${appointment.name || ''}</td>
                    <td>${appointment.phone || ''}</td>
                    <td>${appointment.bookingDate || ''} ${appointment.bookingTime || ''}</td>
                    <td>${appointment.bikeModel || ''}</td>
                    <td>${appointment.licensePlate || 'N/A'}</td>
                    <td><span class="status-badge status-pending">待處理</span></td>
                    <td class="action-buttons">
                        <button class="btn-edit" data-type="maintenance" data-id="${appointment.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" data-type="maintenance" data-id="${appointment.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadFormSubmissions();
            
            // 使用事件委託來處理動態載入的按鈕
            document.addEventListener('click', function(e) {
                // 處理保養預約刷新按鈕
                if (e.target && e.target.id === 'refresh-maintenance') {
                    e.preventDefault();
                    loadAndDisplayMaintenance();
                }
                // 處理賞車預約刷新按鈕
                else if (e.target && e.target.id === 'refresh-test-drive') {
                    e.preventDefault();
                    loadAndDisplayTestDrives();
                }
                // 處理活動報名刷新按鈕
                else if (e.target && e.target.id === 'refresh-events') {
                    e.preventDefault();
                    loadAndDisplayEvents();
                }
            });
            
            // 初始化時載入所有數據
            loadAndDisplayMaintenance();
            loadAndDisplayTestDrives();
            loadAndDisplayEvents();
        });
        
        // 載入並顯示保養預約數據
        function loadAndDisplayMaintenance() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#maintenance-table tbody');
            
            if (!tableBody) {
                console.error('找不到表格主體元素');
                return;
            }
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            // 過濾出保養預約
            const maintenanceSubmissions = submissions.filter(sub => sub.type === 'maintenance');
            
            // 更新今日預約保養計數
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = maintenanceSubmissions.filter(sub => sub.date === today);
            updateTodayAppointmentCount(todayAppointments.length);
            
            if (maintenanceSubmissions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暫無預約記錄</td></tr>';
                return;
            }
            
            // 按日期和時間排序（最近的排前面）
            maintenanceSubmissions.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateA - dateB;
            });
            
            maintenanceSubmissions.forEach((submission, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${submission.date || ''} ${submission.time || ''}</td>
                    <td>${submission.name || ''}</td>
                    <td>${submission.phone || ''}</td>
                    <td>${submission.bikeModel || ''}</td>
                    <td>${getServiceTypeText(submission.serviceType)}</td>
                    <td>${submission.notes || ''}</td>
                    <td>
                        <div class="price-edit" data-id="${submission.id}">
                            <input type="text" class="price-input" value="${submission.price || ''}" placeholder="輸入價格" 
                                   onchange="updatePrice('${submission.id}', this.value)" 
                                   onblur="this.value = this.value.replace(/[^\d.]/g, '')"
                                   style="width: 80px; text-align: right;"
                                   ${submission.status === 'completed' ? 'readonly' : ''}>
                            <span>元</span>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${submission.status === 'completed' ? 'status-completed' : 'status-pending'}">
                            ${submission.status === 'completed' ? '已完成' : '未處理'}
                        </span>
                    </td>
                    <td>
                        <button class="btn-edit" onclick="updateStatus('${submission.id}')">
                            ${submission.status === 'completed' ? '標記未完成' : '標記完成'}
                        </button>
                        <button class="btn-delete" onclick="deleteSubmission(\'${submission.id}\')">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 載入並顯示賞車預約數據
        function loadAndDisplayTestDrives() {
            const testDrives = JSON.parse(localStorage.getItem('testDrives') || '[]');
            const tbody = document.querySelector('#test-drive-table tbody');
            
            if (!tbody) {
                console.error('找不到表格主體元素');
                return;
            }
            
            // 清空現有內容
            tbody.innerHTML = '';
            
            if (testDrives.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">暫無預約資料</td>';
                tbody.appendChild(row);
                return;
            }
            
            // 更新今日預約計數
            const today = new Date().toISOString().split('T')[0];
            const todayCount = testDrives.filter(drive => 
                drive.appointmentDate === today
            ).length;
            updateTodayTestDriveCount(todayCount);
            
            // 按預約日期排序（最新的在前面）
            const sortedTestDrives = [...testDrives].sort((a, b) => {
                const dateA = new Date(a.appointmentDate + ' ' + (a.timeSlot || '')).getTime();
                const dateB = new Date(b.appointmentDate + ' ' + (b.timeSlot || '')).getTime();
                return dateB - dateA;
            });
            
            // 生成表格行
            sortedTestDrives.forEach((testDrive) => {
                const row = document.createElement('tr');
                updateTestDriveTableRow(row, testDrive);
                tbody.appendChild(row);
            });
        }
        
        // 載入並顯示活動報名數據
        function loadAndDisplayEvents() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#events-section tbody');
            
            if (!tableBody) {
                console.error('找不到活動報名表格主體元素');
                return;
            }
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            // 過濾出活動報名
            const eventSubmissions = submissions.filter(sub => sub.type === 'event');
            
            // 更新活動報名人數計數
            updateEventRegistrationCount(eventSubmissions.length);
            
            if (eventSubmissions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暫無活動報名記錄</td></tr>';
                return;
            }
            
            // 按活動日期排序（最近的排前面）
            eventSubmissions.sort((a, b) => {
                const dateA = new Date(a.eventDate);
                const dateB = new Date(b.eventDate);
                return dateA - dateB;
            });
            
            // 將活動分組
            const events = {};
            eventSubmissions.forEach(submission => {
                if (!events[submission.eventId]) {
                    events[submission.eventId] = {
                        name: submission.eventName,
                        date: submission.eventDate,
                        location: submission.eventLocation || '未指定',
                        maxParticipants: submission.maxParticipants || 100,
                        participants: []
                    };
                }
                events[submission.eventId].participants.push(submission);
            });
            
            // 顯示活動列表
            Object.values(events).forEach((event, index) => {
                const row = document.createElement('tr');
                const participantCount = event.participants.length;
                const isFull = participantCount >= event.maxParticipants;
                
                row.innerHTML = `
                    <td>${event.name || '未命名活動'}</td>
                    <td>${event.date || '未設定日期'}</td>
                    <td>${event.location}</td>
                    <td>${participantCount}/${event.maxParticipants}</td>
                    <td><span style="color: ${isFull ? 'var(--danger-color)' : 'var(--success-color)'};">
                        ${isFull ? '已額滿' : '接受報名中'}
                    </span></td>
                    <td>
                        <button class="btn-edit" onclick="viewEventParticipants('${event.name}')">
                            查看名單 (${participantCount})
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 更新今日賞車預約計數
        function updateTodayTestDriveCount(count) {
            const todayTestDrivesElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (todayTestDrivesElement) {
                todayTestDrivesElement.textContent = count;
                todayTestDrivesElement.nextElementSibling.textContent = count > 0 ? `今日有 ${count} 筆預約` : '尚無資料';
            }
        }
        
        // 更新活動報名人數計數
        function updateEventRegistrationCount(count) {
            const eventRegistrationsElement = document.querySelector('.stat-card:nth-child(3) .stat-number');
            if (eventRegistrationsElement) {
                eventRegistrationsElement.textContent = count;
                eventRegistrationsElement.nextElementSibling.textContent = count > 0 ? `${count} 人已報名` : '尚無報名';
            }
        }
        
        // 更新賞車預約狀態
        function updateTestDriveStatus(id, status) {
            const testDrives = JSON.parse(localStorage.getItem('testDrives') || '[]');
            const index = testDrives.findIndex(drive => drive.id === id);
            
            if (index !== -1) {
                testDrives[index].status = status;
                localStorage.setItem('testDrives', JSON.stringify(testDrives));
                
                // 更新表格顯示
                const tbody = document.querySelector('#test-drive-table tbody');
                if (tbody) {
                    const rows = Array.from(tbody.rows);
                    const rowIndex = rows.findIndex(row => {
                        const btn = row.querySelector('.btn-status');
                        return btn && btn.onclick && btn.onclick.toString().includes(`'${id}'`);
                    });
                    
                    if (rowIndex !== -1) {
                        updateTestDriveTableRow(tbody.rows[rowIndex], testDrives[index]);
                    } else {
                        // 如果找不到對應的行，重新加載整個表格
                        loadAndDisplayTestDrives();
                    }
                }
                
                // 顯示成功消息
                showToast('狀態更新成功', 'success');
            }
        }
        
        // 刪除賞車預約
        function deleteTestDrive(id) {
            if (!confirm('確定要刪除此筆賞車預約嗎？')) {
                return false; // 如果用戶取消，則不執行刪除
            }
            
            try {
                const testDrives = JSON.parse(localStorage.getItem('testDrives') || '[]');
                const updatedTestDrives = testDrives.filter(drive => drive.id !== id);
                
                if (updatedTestDrives.length === testDrives.length) {
                    console.error('找不到要刪除的賞車預約');
                    showToast('錯誤：找不到要刪除的預約', 'error');
                    return false;
                }
                
                // 更新 localStorage
                localStorage.setItem('testDrives', JSON.stringify(updatedTestDrives));
                
                // 重新載入顯示
                loadAndDisplayTestDrives();
                
                // 顯示成功消息
                showToast('賞車預約已成功刪除', 'success');
                return true;
                
            } catch (error) {
                console.error('刪除賞車預約時發生錯誤:', error);
                showToast('刪除賞車預約時發生錯誤，請稍後再試', 'error');
                return false;
            }
        }
        
        // 查看活動參與者
        function viewEventParticipants(eventName) {
            alert(`查看 ${eventName} 的參與者名單功能將在後續版本中提供。`);
        }
        
        // 獲取服務類型文字
        function getServiceTypeText(type) {
            const types = {
                'check_condition': '車況檢查',
                'oil': '機油更換',
                'major': '大保養',
                'inspection': '年度健檢',
                'tires': '輪胎更換',
                'brakes': '煞車系統',
                'chain': '鏈條保養',
                'accident': '事故維修',
                'engine': '引擎檢查',
                'other': '其他'
            };
            return types[type] || type;
        }
        
        // 更新今日預約保養計數
        function updateTodayAppointmentCount(count) {
            const todayAppointmentsElement = document.querySelector('.stat-card:nth-child(1) .stat-number');
            if (todayAppointmentsElement) {
                todayAppointmentsElement.textContent = count;
                todayAppointmentsElement.nextElementSibling.textContent = count > 0 ? `今日有 ${count} 筆預約` : '尚無資料';
            }
        }
        
        // 獲取狀態文字
        function getStatusText(status) {
            const statusMap = {
                'pending': '未賞車',
                'completed': '已賞車'
            };
            return statusMap[status] || '未知';
        }
        
        // 更新狀態
        function updateStatus(index, status) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            if (submissions[index]) {
                submissions[index].status = status;
                // 如果是完成狀態，添加完成時間
                if (status === 'completed') {
                    submissions[index].completedAt = new Date().toISOString();
                }
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                loadAndDisplayMaintenance();
            }
        }
        
        // 刪除項目
        function deleteItem(type, id) {
            if (!confirm('確定要刪除此筆預約嗎？')) {
                return;
            }
            
            try {
                const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                const updatedSubmissions = submissions.filter(submission => submission.id !== id);
                
                if (updatedSubmissions.length === submissions.length) {
                    console.error('找不到要刪除的預約');
                    alert('錯誤：找不到要刪除的預約');
                    return;
                }
                
                localStorage.setItem('formSubmissions', JSON.stringify(updatedSubmissions));
                
                // 根據類型重新載入對應的數據
                if (type === 'maintenance') {
                    loadAndDisplayMaintenance();
                } else if (type === 'test-drive') {
                    loadAndDisplayTestDrives();
                } else if (type === 'event') {
                    loadAndDisplayEvents();
                }
                
                console.log('預約已成功刪除');
            } catch (error) {
                console.error('刪除預約時發生錯誤:', error);
                alert('刪除預約時發生錯誤，請稍後再試');
            }
        }

        // 載入並顯示表單提交數據
        function loadAndDisplaySubmissions() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const tableBody = document.querySelector('#maintenance-table tbody');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = ''; // 清空現有內容
            
            submissions.forEach((submission, index) => {
                if (submission.type === 'maintenance') {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${submission.name || ''}</td>
                        <td>${submission.phone || ''}</td>
                        <td>${submission.bikeModel || ''}</td>
                        <td>${getServiceTypeText(submission.serviceType)}</td>
                        <td>${submission.date || ''} ${submission.time || ''}</td>
                        <td>${submission.notes || ''}</td>
                        <td>
                            <div class="price-edit" data-id="${submission.id}">
                                <input type="text" class="price-input" value="${submission.price || ''}" placeholder="輸入價格" 
                                       onchange="updatePrice('${submission.id}', this.value)" 
                                       style="width: 80px; text-align: right;">
                                <span>元</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${submission.status === 'completed' ? 'status-completed' : 'status-pending'}">
                                ${submission.status === 'completed' ? '已完成' : '未處理'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-edit" onclick="updateStatus('${submission.id}')">
                                ${submission.status === 'completed' ? '標記未完成' : '標記完成'}
                            </button>
                            <button class="btn-delete" onclick="deleteSubmission(\'${submission.id}\')">刪除</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        // 獲取服務類型文字
        function getServiceTypeText(type) {
            const types = {
                'check_condition': '車況檢查',
                'oil': '機油更換',
                'major': '大保養',
                'inspection': '年度健檢',
                'tires': '輪胎更換',
                'brakes': '煞車系統',
                'chain': '鏈條保養',
                'accident': '事故維修',
                'engine': '引擎檢查',
                'other': '其他'
            };
            return types[type] || type;
        }

        // 更新價格
        function updatePrice(submissionId, newPrice) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const submission = submissions.find(s => s.id === submissionId);
            
            if (submission) {
                // 移除非數字字符，只保留數字和小數點
                const numericValue = newPrice.replace(/[^\d.]/g, '');
                submission.price = numericValue;
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                
                // 重新載入數據以更新顯示
                loadAndDisplayMaintenance();
            }
        }

        // 更新狀態（切換完成/未完成）
        function updateStatus(submissionId) {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const submission = submissions.find(s => s.id === submissionId);
            
            if (submission) {
                // 切換狀態
                submission.status = submission.status === 'completed' ? 'pending' : 'completed';
                
                if (submission.status === 'completed') {
                    submission.completedAt = new Date().toISOString();
                } else {
                    // 如果狀態改回未完成，清除完成時間
                    delete submission.completedAt;
                }
                
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                loadAndDisplayMaintenance();
            }
        }

        // 刪除預約
        function deleteSubmission(submissionId) {
            if (!submissionId) {
                console.error('刪除失敗：無效的 ID', submissionId);
                alert('刪除失敗：無效的 ID');
                return;
            }
            
            if (!confirm('確定要刪除此筆預約嗎？')) {
                return; // 如果用戶取消，則不執行刪除
            }
            
            try {
                const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                
                // 日誌輸出當前要刪除的 ID 和類型
                console.log('嘗試刪除 ID:', submissionId, '類型:', typeof submissionId, '所有項目:', submissions);
                
                // 改進的 ID 比對邏輯，處理數字和字符串類型的 ID
                const submissionIndex = submissions.findIndex(s => {
                    if (!s) return false;
                    const id1 = String(s.id || '');
                    const id2 = String(submissionId || '');
                    return id1 === id2;
                });
                
                if (submissionIndex === -1) {
                    console.error('找不到要刪除的預約項目，ID:', submissionId, '類型:', typeof submissionId, '所有項目:', submissions);
                    alert('錯誤：找不到要刪除的預約項目，請刷新頁面後重試');
                    return;
                }
                
                // 獲取要刪除的項目類型
                const deletedItemType = submissions[submissionIndex].type || 'maintenance';
                
                // 從陣列中移除該筆預約
                submissions.splice(submissionIndex, 1);
                
                // 更新 localStorage
                localStorage.setItem('formSubmissions', JSON.stringify(submissions));
                
                // 根據項目類型重新載入對應的數據
                if (deletedItemType === 'test-drive') {
                    loadAndDisplayTestDrives();
                } else if (deletedItemType === 'event') {
                    loadAndDisplayEvents();
                } else {
                    loadAndDisplayMaintenance();
                }
                
                console.log('預約已成功刪除', '類型:', deletedItemType);
            } catch (error) {
                console.error('刪除預約時發生錯誤:', error);
                alert('刪除預約時發生錯誤，請稍後再試');
            }
        }
        
        // 獲取狀態對應的 CSS 類名
        function getStatusClass(status) {
            switch(status) {
                case 'completed':
                    return 'status-completed';
                case 'processing':
                    return 'status-processing';
                case 'pending':
                default:
                    return 'status-pending';
            }
        }
        
        // 獲取狀態對應的文字
        function getStatusText(status) {
            switch(status) {
                case 'completed':
                    return '已完成';
                case 'processing':
                    return '處理中';
                case 'pending':
                default:
                    return '待處理';
            }
        }
        
        // 表單類型對應的中文名稱
        const formTypeNames = {
            'test-drive': '預約試乘',
            'service': '保養預約',
            'event': '活動報名'
        };
        
        // 表單類型對應的標籤頁ID
        const formTypeToTab = {
            'test-drive': 'test-drive',
            'service': 'maintenance',
            'event': 'events'
        };

        // 表單模板
        const formTemplates = {
            maintenance: {
                title: '預約保養',
                fields: [
                    { type: 'text', id: 'customerName', label: '客戶姓名', required: true },
                    { type: 'tel', id: 'phone', label: '聯絡電話', required: true },
                    { type: 'date', id: 'appointmentDate', label: '預約日期', required: true },
                    { type: 'time', id: 'appointmentTime', label: '預約時間', required: true },
                    { type: 'select', id: 'serviceType', label: '服務類型', options: ['定期保養', '一般維修', '事故維修', '其他'], required: true },
                    { type: 'textarea', id: 'notes', label: '備註' }
                ]
            },
            testDrive: {
                title: '預約試乘',
                fields: [
                    { type: 'text', id: 'customerName', label: '客戶姓名', placeholder: '您的姓名', required: true },
                    { type: 'tel', id: 'phone', label: '聯絡電話', placeholder: '聯絡電話', required: true },
                    { 
                        type: 'select', 
                        id: 'brand', 
                        label: '品牌', 
                        placeholder: '— 第一步：請選擇品牌 —',
                        options: [
                            {value: '', text: '— 第一步：請選擇品牌 —', disabled: true, selected: true},
                            {value: 'kawasaki', text: 'KAWASAKI 川崎'},
                            {value: 'kymco', text: 'KYMCO 光陽'},
                            {value: 'used', text: '二手車輛'}
                        ],
                        required: true,
                        onchange: 'updateTestDriveModels(this)'
                    },
                    { 
                        type: 'select', 
                        id: 'carModel', 
                        label: '車型',
                        placeholder: '— 第二步：請選擇預約車款 —',
                        options: [{value: '', text: '— 第二步：請選擇預約車款 —', disabled: true, selected: true}],
                        required: true,
                        disabled: true
                    },
                    { 
                        type: 'date', 
                        id: 'appointmentDate', 
                        label: '預約日期', 
                        required: true, 
                        min: new Date().toISOString().split('T')[0],
                        onchange: 'generateTimeSlots(this)'
                    },
                    { 
                        type: 'select', 
                        id: 'timeSlot', 
                        label: '預約時段',
                        options: [{value: '', text: '請選擇時間', disabled: true, selected: true}],
                        required: true,
                        disabled: true
                    },
                    { 
                        type: 'textarea', 
                        id: 'notes', 
                        label: '備註',
                        placeholder: '若有特殊需求請備註',
                        rows: 3
                    }
                ]
            },
            event: {
                title: '活動報名',
                fields: [
                    { type: 'text', id: 'eventName', label: '活動名稱', required: true },
                    { type: 'date', id: 'eventDate', label: '活動日期', required: true },
                    { type: 'number', id: 'maxParticipants', label: '人數上限', min: 1, required: true },
                    { type: 'textarea', id: 'description', label: '活動說明', required: true }
                ]
            },
            inventory: {
                title: '車輛庫存',
                fields: [
                    { type: 'text', id: 'model', label: '車型', required: true },
                    { type: 'number', id: 'year', label: '年份', min: 2000, max: new Date().getFullYear() + 1, required: true },
                    { type: 'text', id: 'color', label: '顏色', required: true },
                    { type: 'number', id: 'price', label: '價格', min: 0, step: 1000, required: true },
                    { type: 'number', id: 'stock', label: '庫存數量', min: 0, required: true },
                    { type: 'text', id: 'vin', label: '車身號碼 (VIN)' },
                    { type: 'file', id: 'image', label: '車輛圖片', accept: 'image/*' }
                ]
            }
        };

        // 避免重複初始化
        let isInitialized = false;
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (!isInitialized) {
                initTabs();
                initModals();
                initButtons();
                showTab('dashboard');
                isInitialized = true;
            }
        });

        // 初始化標籤頁切換
        function initTabs() {
            // 先移除所有現有的事件監聽器
            document.querySelectorAll('.menu-item[data-tab]').forEach(item => {
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });
            
            // 添加新的事件監聽器
            document.querySelectorAll('.menu-item[data-tab]').forEach(item => {
                item.addEventListener('click', handleTabClick);
            });

            //更新事件監聽(若刪除資料的話要更新)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('btn-delete')) {
                    e.preventDefault();
                    const button = e.target.closest('.btn-delete');
                    const type = button.getAttribute('data-type');
                    const id = button.getAttribute('data-id');
                    if (type && id && confirm('確定要刪除此項目嗎？')) {
                        deleteItem(type, id);
                    }
                }
            });

            // 檢查URL的hash來決定顯示哪個頁面
            function checkHash() {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const tabElement = document.querySelector(`.menu-item[data-tab="${hash}"]`);
                    if (tabElement) {
                        showTab(hash);
                        return;
                    }
                }
                // 如果沒有匹配的hash或hash為空，顯示儀表板
                showTab('dashboard');
            }
            
            // 處理標籤點擊
            function handleTabClick(e) {
                e.preventDefault();
                const tabId = this.getAttribute('data-tab');
                showTab(tabId);
            }

            // 監聽hash變化
            window.addEventListener('hashchange', checkHash, { once: true });
            
            // 頁面載入時檢查hash
            checkHash();
        }

        // 切換標籤頁
        function showTab(tabId, event) {
            if (event) {
                event.preventDefault();
            }
            
            // 更新當前標籤
            currentTab = tabId;
            
            // 更新選單項目的active類
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 找到對應的選單項目並添加active類
            const menuItem = document.querySelector(`.menu-item[data-tab="${tabId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
            
            // 隱藏所有內容區塊
            document.querySelectorAll('.card').forEach(card => {
                card.style.display = 'none';
            });
            
            // 顯示當前選中的內容區塊
            const targetSection = document.getElementById(tabId + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // 根據當前標籤載入對應的數據
                loadTabData(tabId);
                
                // 滾動到頂部
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // 更新頁面標題
                let pageTitle = menuItem ? menuItem.textContent.trim() : tabId;
                // 特別處理保養預約的標題
                if (tabId === 'maintenance') {
                    pageTitle = '預約保養管理';
                } else if (tabId === 'test-drive') {
                    pageTitle = '預約管理';
                } else if (tabId === 'events') {
                    pageTitle = '活動報名管理';
                } else if (tabId === 'inventory') {
                    pageTitle = '現車庫存管理';
                }
                const pageHeader = document.querySelector('.page-header h1');
                if (pageHeader) {
                    pageHeader.innerHTML = `<i class="fas ${getTabIcon(tabId)}"></i> ${pageTitle}`;
                }
                
                // 更新URL的hash
                window.location.hash = tabId;
                
                // 更新麵包屑
                const breadcrumb = document.querySelector('.breadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = `
                        <a href="#" onclick="showTab('dashboard', event); return false;">首頁</a> /
                        <span>${pageTitle}</span>
                    `;
                }
            }
        }
        
        // 獲取標籤頁圖標
        function getTabIcon(tabId) {
            const icons = {
                'dashboard': 'fa-tachometer-alt',
                'maintenance': 'fa-tools',
                'test-drive': 'fa-car',
                'events': 'fa-calendar-alt',
                'inventory': 'fa-warehouse',
                'settings': 'fa-cog',
                'logout': 'fa-sign-out-alt'
            };
            return icons[tabId] || 'fa-folder';
        }

        // 初始化模態框
        function initModals() {
            // 關閉按鈕
            document.getElementById('closeModal').addEventListener('click', closeModal);
            
            // 點擊模態框外部關閉
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // 阻止點擊模態框內容時關閉
            document.querySelector('.modal-content').addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // 初始化按鈕事件
        function initButtons() {
            // 新增按鈕
            document.getElementById('add-maintenance').addEventListener('click', () => openModal('maintenance'));
            document.getElementById('add-test-drive').addEventListener('click', () => openModal('testDrive'));
            document.getElementById('add-event').addEventListener('click', () => openModal('event'));
            document.getElementById('add-inventory').addEventListener('click', () => openModal('inventory'));
            
            // 導航按鈕
            document.querySelector('.admin-logo').addEventListener('click', (e) => {
                e.preventDefault();
                showTab('dashboard');
            });
            
            // 登出按鈕
            document.querySelectorAll('.menu-item').forEach(item => {
                if (item.querySelector('.fa-sign-out-alt')) {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('確定要登出系統嗎？')) {
                            window.location.href = 'login.html';
                        }
                    });
                } else if (item.getAttribute('data-tab') === 'settings') {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        alert('系統設定功能開發中');
                    });
                }
            });
            
            // 返回官網按鈕
            document.querySelector('.btn-outline').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = '../index.html';
            });
        }
        
        // 打開編輯模態框
        function openModalForEdit(type, item) {
            currentModal = type;
            const modal = document.getElementById('modal');
            const template = formTemplates[type];
            
            if (!template) return;
            
            // 設置標題
            document.getElementById('modalTitle').textContent = `編輯${template.title}`;
            
            // 生成表單並填充數據
            let formHTML = `
                <form id="${type}Form" class="modal-form">
                    <input type="hidden" name="id" value="${item.id || ''}">
                    <div class="form-grid">
            `;
            
            template.fields.forEach(field => {
                const value = item[field.id] || '';
                const required = field.required ? 'required' : '';
                let inputHTML = '';
                
                switch(field.type) {
                    case 'select':
                        inputHTML = `
                            <select id="${field.id}" name="${field.id}" class="form-control" ${required}>
                                <option value="">請選擇</option>
                                ${field.options.map(opt => 
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                        break;
                        
                    case 'textarea':
                        inputHTML = `<textarea id="${field.id}" name="${field.id}" class="form-control" rows="3" ${required}>${value}</textarea>`;
                        break;
                        
                    default:
                        const min = field.min !== undefined ? `min="${field.min}"` : '';
                        const max = field.max !== undefined ? `max="${field.max}"` : '';
                        const step = field.step !== undefined ? `step="${field.step}"` : '';
                        const accept = field.accept ? `accept="${field.accept}"` : '';
                        inputHTML = `<input type="${field.type}" id="${field.id}" name="${field.id}" class="form-control" value="${value}" ${required} ${min} ${max} ${step} ${accept}>`;
                }
                
                formHTML += `
                    <div class="form-group">
                        <label for="${field.id}">${field.label}${field.required ? ' <span class="required">*</span>' : ''}</label>
                        ${inputHTML}
                    </div>
                `;
            });
            
            formHTML += `
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">更新</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formContent').innerHTML = formHTML;
            
            // 添加表單提交事件
            document.getElementById(`${type}Form`).addEventListener('submit', handleFormSubmit);
            
            // 顯示模態框
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 打開新增模態框
        function openModal(type) {
            currentModal = type;
            const modal = document.getElementById('modal');
            const template = formTemplates[type];
            
            if (!template) return;
            
            // 設置標題
            document.getElementById('modalTitle').textContent = `新增${template.title}`;
            
            // 生成表單
            let formHTML = `
                <form id="${type}Form" class="modal-form">
                    <div class="form-grid">
            `;
            
            template.fields.forEach(field => {
                const required = field.required ? 'required' : '';
                let inputHTML = '';
                
                switch(field.type) {
                    case 'select':
                        inputHTML = `
                            <select id="${field.id}" name="${field.id}" class="form-control" ${required}>
                                <option value="">請選擇</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `;
                        break;
                        
                    case 'textarea':
                        inputHTML = `<textarea id="${field.id}" name="${field.id}" class="form-control" rows="3" ${required}></textarea>`;
                        break;
                        
                    default:
                        const min = field.min !== undefined ? `min="${field.min}"` : '';
                        const max = field.max !== undefined ? `max="${field.max}"` : '';
                        const step = field.step !== undefined ? `step="${field.step}"` : '';
                        const accept = field.accept ? `accept="${field.accept}"` : '';
                        inputHTML = `<input type="${field.type}" id="${field.id}" name="${field.id}" class="form-control" ${required} ${min} ${max} ${step} ${accept}>`;
                }
                
                formHTML += `
                    <div class="form-group">
                        <label for="${field.id}">${field.label}${field.required ? ' <span class="required">*</span>' : ''}</label>
                        ${inputHTML}
                    </div>
                `;
            });
            
            formHTML += `
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formContent').innerHTML = formHTML;
            
            // 添加表單提交事件
            document.getElementById(`${type}Form`).addEventListener('submit', handleFormSubmit);
            
            // 顯示模態框
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 關閉模態框
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('formContent').innerHTML = '';
            }, 300);
        }
        
        // 處理表單提交
        function handleFormSubmit(e) {
            e.preventDefault();
            
            // 獲取表單數據
            const form = e.target;
            const formData = new FormData(form);
            const formValues = {};
            
            for (let [key, value] of formData.entries()) {
                formValues[key] = value;
            }
            
            // 獲取當前表單類型
            const formType = currentModal;
            
            // 從本地存儲獲取現有數據
            let submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            
            if (formValues.id) {
                // 更新現有項目
                const index = submissions.findIndex(item => {
                    const itemId = String(item.id || '');
                    const formId = String(formValues.id || '');
                    return itemId === formId;
                });
                
                if (index !== -1) {
                    // 更新現有項目
                    submissions[index] = {
                        ...submissions[index],
                        ...formValues,
                        id: submissions[index].id, // 保持原ID不變
                        type: formType === 'maintenance' ? 'service' : 
                              formType === 'events' ? 'event' : formType,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // 添加新項目
                const newItem = {
                    ...formValues,
                    id: Date.now(),
                    type: formType === 'maintenance' ? 'service' : 
                          formType === 'events' ? 'event' : formType,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                submissions.push(newItem);
            }
            
            // 保存到本地存儲
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));
            
            // 關閉模態框
            closeModal();
            
            // 刷新當前標籤頁的數據
            loadTabData(currentTab);
            
            // 顯示成功消息
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.textContent = formValues.id ? '更新成功！' : '新增成功！';
            document.body.appendChild(toast);
            
            // 3秒後移除提示
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // 編輯項目
        function editItem(type, id) {
            // 從本地存儲中獲取數據
            const savedData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            
            // 查找要編輯的項目
            const itemToEdit = savedData.find(item => {
                const itemType = item.type || '';
                const itemId = String(item.id || '');
                const targetId = String(id || '');
                
                if (type === 'maintenance' && itemType === 'service') {
                    return itemId === targetId;
                } else if (type === 'events' && itemType === 'event') {
                    return itemId === targetId;
                } else {
                    return itemType === type && itemId === targetId;
                }
            });
            
            if (itemToEdit) {
                // 填充表單並打開編輯模態框
                openModalForEdit(type, itemToEdit);
            } else {
                alert('找不到要編輯的項目');
            }
        }
        
        // 如果沒有找到數據，使用模擬數據（僅在第一次加載時）
        if (tabData.length === 0 && !localStorage.getItem('initialDataLoaded')) {
            tabData = getMockData(tabId);
            // 保存模擬數據到 localStorage
            const existingData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const newData = [...existingData, ...tabData];
            localStorage.setItem('formSubmissions', JSON.stringify(newData));
        }
            localStorage.setItem('initialDataLoaded', 'true');
        function loadTabData(tabId) {
            // 清空現有數據
            const tableBody = document.querySelector(`#${tabId}-section tbody`);
            if (tableBody) {
                tableBody.innerHTML = '';
                
                // 從 localStorage 獲取數據
                let tabData = [];
                const savedData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                
                if (savedData && savedData.length > 0) {
                    // 過濾出當前標籤頁的數據
                    if (tabId === 'test-drive') {
                        tabData = savedData.filter(item => item.type === 'test-drive');
                    } else if (tabId === 'maintenance') {
                        tabData = savedData.filter(item => item.type === 'service');
                    } else if (tabId === 'events') {
                        tabData = savedData.filter(item => item.type === 'event');
                    } else {
                        tabData = savedData.filter(item => item.type === tabId);
                    }
                }
                
                // 如果沒有找到數據，使用模擬數據（僅在第一次加載時）
                if (tabData.length === 0 && !localStorage.getItem('initialDataLoaded')) {
                    tabData = getMockData(tabId);
                    // 確保每個項目都有唯一的 ID
                    tabData = tabData.map(item => ({
                        ...item,
                        id: item.id || Date.now().toString() + Math.floor(Math.random() * 1000).toString()
                    }));
                    // 保存模擬數據到 localStorage
                    const existingData = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
                    const newData = [...existingData, ...tabData];
                    localStorage.setItem('formSubmissions', JSON.stringify(newData));
                    localStorage.setItem('initialDataLoaded', 'true');
                    
                    // 重新加載數據
                    return loadTabData(tabId);
                }
                
                // 確保現有數據中的每個項目都有 ID
                tabData = tabData.map(item => ({
                    ...item,
                    id: item.id || Date.now().toString() + Math.floor(Math.random() * 1000).toString()
                }));
                
                // 排序數據，最新的在前面
                tabData.sort((a, b) => {
                    const dateA = new Date(a.date || a.createdAt || 0);
                    const dateB = new Date(b.date || b.createdAt || 0);
                    return dateB - dateA;
                });
                
                // 渲染數據到表格
                if (tabData && tabData.length > 0) {
                    tabData.forEach(item => {
                        const row = document.createElement('tr');
                        const itemType = item.type === 'service' ? 'maintenance' : 
                                       item.type === 'event' ? 'events' : item.type;
                        row.setAttribute('data-type', itemType);
                        row.setAttribute('data-id', item.id);
                        row.innerHTML = generateTableRow(tabId, item);
                        tableBody.appendChild(row);
                    });
                } else {
                    // 如果沒有數據，顯示提示信息
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = '10';
                    cell.className = 'text-center py-4 text-muted';
                    cell.textContent = '沒有找到相關數據';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            }
        }
        
        
        
        // 生成表格行
        function generateTableRow(tabId, item) {
            // 根據表單類型顯示不同的欄位
            const formType = item.type || tabId;
            
            // 格式化日期
            const formatDate = (dateString) => {
                if (!dateString) return '--';
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            // 根據表單類型生成對應的行
            switch(formType) {
                case 'test-drive':
                    return `
                        <td>${item.name || '--'}</td>
                        <td>${item.phone || '--'}</td>
                        <td>${item.brand || '--'}</td>
                        <td>${item.model || '--'}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'pending')}">
                                ${getStatusText(item.status || 'pending')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('test-drive', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteSubmission('${item.id}')" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                case 'service':
                    return `
                        <td>${item.name || '--'}</td>
                        <td>${item.phone || '--'}</td>
                        <td>${item.vehicleBrand || '--'}</td>
                        <td>${item.vehicleModel || '--'}</td>
                        <td>${item.serviceType || '--'}</td>
                        <td>${formatDate(item.appointmentDate)} ${item.appointmentTime || ''}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'pending')}">
                                ${getStatusText(item.status || 'pending')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('maintenance', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteSubmission('${item.id}')" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                case 'event':
                    return `
                        <td>${item.eventName || '--'}</td>
                        <td>${item.name || '--'}</td>
                        <td>${item.phone || '--'}</td>
                        <td>${item.email || '--'}</td>
                        <td>${item.participants || '1'} 人</td>
                        <td>${formatDate(item.createdAt || item.date)}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'pending')}">
                                ${getStatusText(item.status || 'pending')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('events', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="if(confirm('確定要刪除此項目嗎？')) { deleteItem('events', '${item.id}'); }" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                case 'inventory':
                    return `
                        <td>${item.licensePlate || '--'}</td>
                        <td>${item.model || '--'}</td>
                        <td>${item.color || '--'}</td>
                        <td>${item.year || '--'}</td>
                        <td>${item.mileage ? `${item.mileage.toLocaleString()} km` : '--'}</td>
                        <td>${item.price ? `$${item.price.toLocaleString()}` : '--'}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(item.status || 'available')}">
                                ${getStatusText(item.status || 'available')}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-action btn-edit" onclick="editItem('${tabId}', '${item.id}')" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="if(confirm('確定要刪除此項目嗎？')) { deleteItem('${tabId}', '${item.id}'); }" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                case 'maintenance':
                    return `
                        <td>${item.name}</td>
                        <td>${item.phone}</td>
                        <td>${item.date} ${item.time}</td>
                        <td>${item.serviceType}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit" onclick="editItem('${tabId}', ${item.id})">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deleteItem('${tabId}', ${item.id})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </td>
                    `;
                case 'events':
                    const progress = Math.min(100, Math.round((item.participants / item.maxParticipants) * 100));
                    return `
                        <td>${item.eventName}</td>
                        <td>${item.date}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <span>${item.participants} / ${item.maxParticipants} 人</span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit" onclick="editItem('${tabId}', ${item.id})">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deleteItem('${tabId}', ${item.id})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </td>
                    `;
                case 'inventory':
                    return `
                        <td>${item.model}</td>
                        <td>${item.year}</td>
                        <td>${item.color}</td>
                        <td>$${item.price.toLocaleString()}</td>
                        <td>${item.stock}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit" onclick="editItem('${tabId}', ${item.id})">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deleteItem('${tabId}', ${item.id})">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </td>
                    `;
                default:
                    return '';
            }
        }  // 新增保養預約
        // 更新賞車預約表格行
        function updateTestDriveTableRow(row, testDrive) {
            const status = testDrive.status || 'pending';
            const statusText = status === 'completed' ? '已賞車' : '未賞車';
            const statusClass = status === 'completed' ? 'status-completed' : 'status-pending';
            
            row.innerHTML = `
                <td>${testDrive.customerName || '--'}</td>
                <td>${testDrive.phone || '--'}</td>
                <td>${testDrive.brand ? testDrive.brand + (testDrive.carModel ? ' - ' + testDrive.carModel : '') : '--'}</td>
                <td>${testDrive.appointmentDate ? new Date(testDrive.appointmentDate).toLocaleDateString('zh-TW') + ' ' + (testDrive.timeSlot || '') : '--'}</td>
                <td>${testDrive.notes || '--'}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="actions">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-status ${status === 'completed' ? 'btn-success' : 'btn-outline-secondary'}" 
                                onclick="updateTestDriveStatus('${testDrive.id}', '${status === 'completed' ? 'pending' : 'completed'}')">
                            <i class="fas ${status === 'completed' ? 'fa-undo' : 'fa-check'}"></i>
                            ${status === 'completed' ? '標記未賞車' : '標記已賞車'}
                        </button>
                        <button class="btn btn-sm btn-edit" onclick="editItem('test-drive', '${testDrive.id}')">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                        <button class="btn btn-sm btn-delete" onclick="if(confirm('確定要刪除此預約嗎？')) { deleteTestDrive('${testDrive.id}'); }">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </div>
                </td>
            `;
        }

        // 載入並顯示賞車預約數據
        function loadAndDisplayTestDrives() {
            const testDrives = JSON.parse(localStorage.getItem('testDrives') || '[]');
            const tbody = document.querySelector('#test-drive-table tbody');
            
            if (!tbody) {
                console.error('找不到表格主體元素');
                return;
            }
            
            // 清空現有內容
            tbody.innerHTML = '';
            
            if (testDrives.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">暫無預約資料</td>';
                tbody.appendChild(row);
                return;
            }
            
            // 更新今日預約計數
            const today = new Date().toISOString().split('T')[0];
            const todayCount = testDrives.filter(drive => 
                drive.appointmentDate === today
            ).length;
            updateTodayTestDriveCount(todayCount);
            
            // 按預約日期排序（最新的在前面）
            const sortedTestDrives = [...testDrives].sort((a, b) => {
                const dateA = new Date(a.appointmentDate + ' ' + (a.timeSlot || '')).getTime();
                const dateB = new Date(b.appointmentDate + ' ' + (b.timeSlot || '')).getTime();
                return dateB - dateA;
            });
            
            // 生成表格行
            sortedTestDrives.forEach((testDrive) => {
                const row = document.createElement('tr');
                updateTestDriveTableRow(row, testDrive);
                tbody.appendChild(row);
            });
        }
        
        // 更新試乘車型選項
        function updateTestDriveModels(selectElement) {
            const modelSelect = document.getElementById('modelSelect');
            const brand = selectElement.value;
            
            // 清空現有選項
            modelSelect.innerHTML = '';
            
            // 根據選擇的品牌添加對應的車型選項
            let options = [{value: '', text: '— 第二步：請選擇預約車款 —', disabled: true, selected: true}];
            
            if (brand === 'kawasaki') {
                options = options.concat([
                    {value: 'ninja_zx10r', text: 'NINJA ZX-10R'},
                    {value: 'ninja_zx6r', text: 'NINJA ZX-6R'},
                    {value: 'z_h2', text: 'Z H2'},
                    {value: 'ninja_h2', text: 'NINJA H2'},
                    {value: 'versys_1000', text: 'VERSYS 1000'},
                    {value: 'z650', text: 'Z650'}
                ]);
            } else if (brand === 'kymco') {
                options = options.concat([
                    {value: 'ak550', text: 'AK550'},
                    {value: 'dt_x360', text: 'DT X360'},
                    {value: 'krv', text: 'KRV'},
                    {value: 'racing_s', text: 'RACING S'},
                    {value: 'new_many', text: 'NEW MANY'}
                ]);
            } else if (brand === 'used') {
                options = options.concat([
                    {value: 'used_1', text: '二手車 1'},
                    {value: 'used_2', text: '二手車 2'},
                    {value: 'used_3', text: '二手車 3'}
                ]);
            }
            
            // 添加選項到下拉選單
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                if (option.disabled) optionElement.disabled = true;
                if (option.selected) optionElement.selected = true;
                modelSelect.appendChild(optionElement);
            });
            
            // 啟用車型選擇
            modelSelect.disabled = !brand;
        }
        
        // 刪除賞車預約
        function deleteTestDrive(id) {
            if (!confirm('確定要刪除此賞車預約嗎？')) return;
            
            const testDrives = JSON.parse(localStorage.getItem('testDrives')) || [];
            const updatedTestDrives = testDrives.filter(drive => drive.id !== id);
            
            localStorage.setItem('testDrives', JSON.stringify(updatedTestDrives));
            loadAndDisplayTestDrives();
            showToast('預約已刪除', 'success');
        }
        
        // 更新今日賞車預約計數
        function updateTodayTestDriveCount(count) {
            const element = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (element) {
                element.textContent = count;
                const changeElement = element.nextElementSibling;
                if (count > 0) {
                    changeElement.textContent = '今日預約';
                    changeElement.style.color = '#2ecc71';
                } else {
                    changeElement.textContent = '尚無預約';
                    changeElement.style.color = '';
                }
            }
        }
        
        // 初始化按鈕事件
        document.getElementById('add-test-drive').addEventListener('click', function() {
            openModal('testDrive');
        });
        
        document.getElementById('refresh-test-drive').addEventListener('click', function() {
            loadAndDisplayTestDrives();
            showToast('賞車預約列表已刷新', 'info');
        });
        
        // 在DOM加載完成時調用
        document.addEventListener('DOMContentLoaded', function() {
            // 確保只綁定一次事件
            const refreshBtn = document.getElementById('refresh-test-drive');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadAndDisplayTestDrives();
                    showToast('賞車預約列表已刷新', 'info');
                });
            }
            
            // 載入初始數據
            loadAndDisplayTestDrives();
        });
        
        document.getElementById('add-maintenance').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '新增保養預約';
            document.getElementById('formContent').innerHTML = `
                <form id="maintenanceForm" onsubmit="saveMaintenance(event)">
                    <div class="form-group">
                        <label for="customerName">客戶姓名</label>
                        <input type="text" id="customerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">聯絡電話</label>
                        <input type="tel" id="phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="appointmentDate">預約日期時間</label>
                        <input type="datetime-local" id="appointmentDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="carModel">車型</label>
                        <input type="text" id="carModel" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="licensePlate">車牌號碼</label>
                        <input type="text" id="licensePlate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">備註</label>
                        <textarea id="notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        });

        // 新增賞車預約
        document.getElementById('add-test-drive').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '預約試乘';
            document.getElementById('formContent').innerHTML = `
                <form id="testDriveForm" onsubmit="saveTestDrive(event)" class="booking-form">
                    <div class="form-group">
                        <input type="text" id="customerName" placeholder="您的姓名" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" id="phone" placeholder="聯絡電話" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <select id="brandSelect" onchange="updateTestDriveModels(this)" class="form-control" required>
                            <option value="" disabled selected>— 第一步：請選擇品牌 —</option>
                            <option value="kawasaki">KAWASAKI 川崎</option>
                            <option value="kymco">KYMCO 光陽</option>
                            <option value="used">二手車輛</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="modelSelect" class="form-control" disabled required>
                            <option value="" disabled selected>— 第二步：請選擇預約車款 —</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <input type="date" id="appointmentDate" class="form-control" onchange="generateTimeSlots(this)" required>
                        <select id="timeSelect" class="form-control" required>
                            <option value="" disabled selected>預約時間</option>
                        </select>
                    </div>
                    <div id="dateError" class="date-hint" style="color: #dc3545; font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; display: none;">
                        ⚠️ 週日公休，請選擇其他日期
                    </div>
                    <div class="form-group">
                        <textarea id="notes" class="form-control" placeholder="若有特殊需求請備註" rows="3"></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">確認提交</button>
                    </div>
                </form>
            `;
            
            // 設置最小日期為明天
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('appointmentDate').min = tomorrow.toISOString().split('T')[0];
            
            modal.style.display = 'flex';
        });
        
        // 更新試乘車型選項
        function updateTestDriveModels(selectElement) {
            const modelSelect = document.getElementById('carModel');
            const brand = selectElement.value;
            
            // 清空現有選項
            modelSelect.innerHTML = '';
            
            // 根據選擇的品牌添加對應的車型選項
            let options = [{value: '', text: '— 第二步：請選擇預約車款 —', disabled: true, selected: true}];
            
            if (brand === 'kawasaki') {
                options = options.concat([
                    {value: 'ninja_zx10r', text: 'NINJA ZX-10R'},
                    {value: 'ninja_zx6r', text: 'NINJA ZX-6R'},
                    {value: 'z_h2', text: 'Z H2'},
                    {value: 'ninja_h2', text: 'NINJA H2'},
                    {value: 'versys_1000', text: 'VERSYS 1000'},
                    {value: 'z650', text: 'Z650'}
                ]);
            } else if (brand === 'kymco') {
                options = options.concat([
                    {value: 'ak550', text: 'AK550'},
                    {value: 'dt_x360', text: 'DT X360'},
                    {value: 'krv', text: 'KRV'},
                    {value: 'racing_s', text: 'RACING S'},
                    {value: 'new_many', text: 'NEW MANY'}
                ]);
            } else if (brand === 'used') {
                options = options.concat([
                    {value: 'used_1', text: '二手車 1'},
                    {value: 'used_2', text: '二手車 2'},
                    {value: 'used_3', text: '二手車 3'}
                ]);
            }
            
            // 添加選項到下拉選單
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                if (option.disabled) optionElement.disabled = true;
                if (option.selected) optionElement.selected = true;
                modelSelect.appendChild(optionElement);
            });
            
            // 啟用車型選擇
            modelSelect.disabled = !brand;
        }
        
        // 生成時間段選項
        function generateTimeSlots(dateInput) {
            const timeSelect = document.getElementById('timeSlot');
            const dateError = dateInput.parentNode.querySelector('.date-hint') || 
                             document.querySelector('.date-hint') || 
                             (() => {
                                const hint = document.createElement('div');
                                hint.className = 'date-hint';
                                hint.style.color = '#dc3545';
                                hint.style.fontSize = '0.875rem';
                                hint.style.marginTop = '-0.5rem';
                                hint.style.marginBottom = '1rem';
                                hint.style.display = 'none';
                                hint.innerHTML = '⚠️ 週日公休，請選擇其他日期';
                                dateInput.parentNode.parentNode.insertBefore(hint, dateInput.parentNode.nextSibling);
                                return hint;
                             })();
            
            const selectedDate = new Date(dateInput.value);
            const dayOfWeek = selectedDate.getDay();
            
            // 清空現有選項
            timeSelect.innerHTML = '';
            
            // 檢查是否為週日（0 是週日）
            if (dayOfWeek === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '週日公休，請選擇其他日期';
                option.disabled = true;
                option.selected = true;
                timeSelect.appendChild(option);
                timeSelect.disabled = true;
                dateError.style.display = 'block';
                return;
            }
            
            // 隱藏錯誤信息
            dateError.style.display = 'none';
            
            // 生成時間段選項（週一至週六）
            const startHour = 9; // 早上9點開始
            const endHour = 17;  // 下午5點結束
            
            // 添加默認選項
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '請選擇時間';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            timeSelect.appendChild(defaultOption);
            
            for (let hour = startHour; hour < endHour; hour++) {
                // 跳過中午12點到1點（午休時間）
                if (hour === 12) continue;
                
                const timeString = `${hour.toString().padStart(2, '0')}:00-${(hour + 1).toString().padStart(2, '0')}:00`;
                const option = document.createElement('option');
                option.value = timeString;
                option.textContent = timeString;
                timeSelect.appendChild(option);
            }
            
            // 啟用時間選擇
            timeSelect.disabled = false;
        }

        // 新增活動
        document.getElementById('add-event').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '新增活動';
            document.getElementById('formContent').innerHTML = `
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <div class="form-group">
                        <label for="eventName">活動名稱</label>
                        <input type="text" id="eventName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDate">活動日期時間</label>
                        <input type="datetime-local" id="eventDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="location">活動地點</label>
                        <input type="text" id="location" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="maxAttendees">最大參加人數</label>
                        <input type="number" id="maxAttendees" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">活動說明</label>
                        <textarea id="eventDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        });

        // 新增車輛庫存
        document.getElementById('add-inventory').addEventListener('click', function() {
            document.getElementById('modalTitle').textContent = '新增車輛庫存';
            document.getElementById('formContent').innerHTML = `
                <form id="inventoryForm" onsubmit="saveInventory(event)">
                    <div class="form-group">
                        <label for="licensePlateNo">車牌號碼</label>
                        <input type="text" id="licensePlateNo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="inventoryModel">車型</label>
                        <select id="inventoryModel" class="form-control" required>
                            <option value="">-- 請選擇車型 --</option>
                            <option value="Model S">Model S</option>
                            <option value="Model 3">Model 3</option>
                            <option value="Model X">Model X</option>
                            <option value="Model Y">Model Y</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="color">顏色</label>
                        <input type="text" id="color" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="year">年份</label>
                        <input type="number" id="year" class="form-control" min="2000" max="2025" required>
                    </div>
                    <div class="form-group">
                        <label for="mileage">里程數 (公里)</label>
                        <input type="number" id="mileage" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="price">售價 (新台幣)</label>
                        <input type="number" id="price" class="form-control" min="0" required>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        });

        // 表單提交處理函數
        function saveMaintenance(e) {
            e.preventDefault();
            // 這裡添加保存邏輯
            alert('保養預約已儲存');
            closeModal();
            showToast('保養預約已保存', 'success');
        }

        function saveTestDrive(e) {
            e.preventDefault();
            const testDriveData = {};
            
            // 將表單數據轉換為對象
            for (let [key, value] of formData.entries()) {
                testDriveData[key] = value;
            }
            
            // 添加ID和創建時間
            if (!testDriveData.id) {
                testDriveData.id = 'td-' + Date.now();
                testDriveData.createdAt = new Date().toISOString();
                testDriveData.status = 'pending'; // 默認狀態為待處理
            }
            
            // 獲取現有數據
            const testDrives = JSON.parse(localStorage.getItem('testDrives')) || [];
            
            if (testDriveData.id) {
                // 更新現有預約
                const index = testDrives.findIndex(item => item.id === testDriveData.id);
                if (index !== -1) {
                    testDrives[index] = { ...testDrives[index], ...testDriveData };
                } else {
                    testDrives.push(testDriveData);
                }
            } else {
                // 添加新預約
                testDrives.push(testDriveData);
            }
            
            // 保存到localStorage
            localStorage.setItem('testDrives', JSON.stringify(testDrives));
            
            // 刷新列表
            loadAndDisplayTestDrives();
            
            // 關閉模態框並顯示成功消息
            closeModal();
            showToast('賞車預約已保存', 'success');
        }

        function saveEvent(e) {
            e.preventDefault();
            // 這裡添加保存邏輯
            alert('活動已建立');
            closeModal();
        }

        function saveInventory(e) {
            e.preventDefault();
            // 這裡添加保存邏輯
            alert('車輛庫存已新增');
            closeModal();
        }
    </script>
    <!-- 引入行動選單 JavaScript -->
    <script src="../js/mobile-menu.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約試乘 | 明德車業 MINGDE MOTOR</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/booking-common.css">
    <link rel="stylesheet" href="css/mobile-menu.css" media="screen and (max-width: 992px)">
    <style>
        /* 預約表單標題樣式 */
        .booking-card h2 {
            text-align: center;
            margin: 0 0 1.25rem 0;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--kawa-green);
        }
        
        /* 副標題樣式 */
        .booking-subtitle {
            display: block;
            text-align: center;
            color: var(--kawa-green);
            font-size: 1.1rem;
            margin: 0 0 2rem 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        /* 表單元素樣式 */
        .booking-form {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .booking-form .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .booking-form .form-row > * {
            flex: 1;
        }
        
        .btn-submit {
            font-size: 1rem !important;
            padding: 12px 24px;
            background-color: var(--kawa-green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .btn-submit:hover {
            background-color: #4a8f29;
        }
    </style>
</head>
<body>

    <header>
        <div class="nav-container">
            <a href="index.html" class="logo-container">
                <img src="image/logo.jpg" alt="明德車業 Logo" class="logo-img">
            </a>
            <button class="menu-toggle" aria-label="選單">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav class="nav-list">
                <a href="index.html">首頁</a>
                <a href="products.html">現車庫存</a>
                <a href="booking-ride.html" class="nav-btn ride">預約試乘</a>
                <a href="booking-service.html" class="nav-btn">保養預約</a>
                <a href="event-signup.html">活動報名</a>
            </nav>
            <div class="overlay"></div>
        </div>
    </header>

    <main class="booking-section">
        <div class="booking-card">
            <h2>預約試乘</h2>
            <span class="booking-subtitle" style="font-weight: bold;">BOOKING YOUR RIDE</span>
            
            <form class="booking-form" id="rideBookingForm">
                <input type="text" placeholder="您的姓名" required>
                <input type="tel" placeholder="聯絡電話" required>

                <select id="brandSelect" onchange="updateModels()" required>
                    <option value="" disabled selected>— 第一步：請選擇品牌 —</option>
                    <option value="kawasaki">KAWASAKI 川崎</option>
                    <option value="kymco">KYMCO 光陽</option>
                    <option value="used">二手車輛</option>
                </select>

                <select id="modelSelect" disabled required>
                    <option value="" disabled selected>— 第二步：請選擇預約車款 —</option>
                </select>

                <div class="form-row">
                    <input type="date" id="bookDate" onchange="generate24HSlots()" required>
                    <select id="timeSelect" required>
                        <option value="" disabled selected>預約時間</option>
                    </select>
                </div>
                <div id="dateError" class="date-hint">⚠️ 週日公休，請選擇其他日期</div>

                <textarea placeholder="若有特殊需求請備註" rows="3"></textarea>
                <button type="submit" class="btn-submit">確認提交</button>
            </form>
        </div>
    </main>

    <section class="footer-info">
            <div class="footer-container">
                <div class="footer-column">
                    <h4>服務項目</h4>
                    <ul>
                        <li><a href="index.html">關於我們</a></li>
                        <li><a href="products.html">現車庫存</a></li>
                        <li><a href="booking-ride.html">預約試乘</a></li>
                        <li><a href="booking-service.html">預約保養</a></li>
                        <li><a href="event-signup.html">活動報名</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>門市位置</h4>
                    <p>高雄市三民區九如二路 575 號</p>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=明德車業有限公司" 
                    target="_blank" class="nav-link">
                    ➤ 開啟 Google 導航
                    </a>
                </div>
                <div class="footer-column">
                    <h4>營業時間</h4>
                    <p>週一至週五：09:30 – 20:30</p>
                    <p>週六：09:30 – 18:00 (隔週休)</p>
                    <p style="color: #ff4d4d; font-weight: bold;">週日：休息</p>
                </div>
                <div class="footer-column">
                    <h4 style="margin-bottom: 20px;">聯絡資訊</h4>
                    <p>Tel: <a href="tel:073111111" class="footer-link">07-311-1111</a></p>
                    <p>FB: <a href="https://www.facebook.com/MingDeCheYeYouXianGongSi/?locale=zh_TW" target="_blank" class="footer-link">明德車業有限公司</a></p>
                    <p>Gmail: <a href="mailto:kawasaki9750@gmail.com" class="footer-link">kawasaki9750@gmail.com</a></p>
                    <p>Line@: <a href="https://line.me/R/ti/p/@mdmotors" target="_blank" class="footer-link">@mdmotors</a></p>
                </div>
            </div>
        </section>

    <script>
        // 從URL獲取參數
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 自動選擇品牌和車型
        function autoSelectBike() {
            const brand = getUrlParameter('brand');
            const model = getUrlParameter('model');
            
            if (brand && model) {
                // 設置品牌
                const brandSelect = document.getElementById('brandSelect');
                const brandLower = brand.toLowerCase();
                
                // 先嘗試精確匹配
                let brandFound = false;
                for (let i = 0; i < brandSelect.options.length; i++) {
                    if (brandSelect.options[i].value.toLowerCase() === brandLower) {
                        brandSelect.selectedIndex = i;
                        // 觸發change事件來加載車型
                        const event = new Event('change');
                        brandSelect.dispatchEvent(event);
                        brandFound = true;
                        
                        // 等待車型加載完成
                        setTimeout(() => {
                            const modelSelect = document.getElementById('modelSelect');
                            // 先嘗試完全匹配
                            let modelFound = false;
                            for (let i = 0; i < modelSelect.options.length; i++) {
                                if (modelSelect.options[i].value === model) {
                                    modelSelect.selectedIndex = i;
                                    modelFound = true;
                                    break;
                                }
                            }
                            // 如果沒找到完全匹配的，嘗試部分匹配
                            if (!modelFound) {
                                for (let i = 0; i < modelSelect.options.length; i++) {
                                    if (modelSelect.options[i].text.includes(model)) {
                                        modelSelect.selectedIndex = i;
                                        modelFound = true;
                                        break;
                                    }
                                }
                            }
                            // 如果還是沒找到，使用第一個可選項
                            if (!modelFound && modelSelect.options.length > 1) {
                                modelSelect.selectedIndex = 1; // 跳過第一個提示選項
                            }
                        }, 200); // 增加等待時間確保車型已載入
                        break;
                    }
                }
                
                // 如果品牌沒找到，使用第一個可選項
                if (!brandFound && brandSelect.options.length > 1) {
                    brandSelect.selectedIndex = 1; // 跳過第一個提示選項
                    const event = new Event('change');
                    brandSelect.dispatchEvent(event);
                }
            }
        }

        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            autoSelectBike();
            
            // 表單提交處理
            const form = document.getElementById('rideBookingForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 收集表單數據
                    const dateInput = document.getElementById('bookDate').value;
                    const timeInput = document.getElementById('timeSelect').value;
                    
                    // 直接保存日期和時間字符串，不轉換為Date對象
                    const formData = {
                        type: 'test-drive',
                        name: form.querySelector('input[type="text"]').value,
                        phone: form.querySelector('input[type="tel"]').value,
                        brand: document.getElementById('brandSelect').value,
                        model: document.getElementById('modelSelect').value,
                        // 直接保存日期和時間字符串（兼容舊欄位）
                        selectedDate: dateInput,
                        selectedTime: timeInput,
                        // 兼容 admin/dashboard.html 使用的欄位名稱
                        date: dateInput,
                        time: timeInput,
                        interestedModel: document.getElementById('modelSelect').value,
                        notes: form.querySelector('textarea').value || '',
                        // 同時保存時間戳以保持向後兼容
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    // 保存到 localStorage
                    saveFormData(formData);
                    
                    // 顯示成功消息並重置表單
                    alert('預約成功，我們將與您聯繫！');
                    form.reset();
                });
            }
        });
        
        // 保存表單數據到 localStorage
        function saveFormData(formData) {
            let submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            formData.id = Date.now(); // 使用時間戳作為唯一ID
            submissions.push(formData);
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));
        }

        // 設定最小預約日期為今天
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        const dateInput = document.getElementById('bookDate');
        dateInput.setAttribute('min', todayString);
        
        // 如果沒有選擇日期，則預設為今天
        if (!dateInput.value) {
            dateInput.value = todayString;
            // 觸發時間段生成
            generate24HSlots();
        }
        
        // 確保時間選擇器是必填的
        document.getElementById('timeSelect').required = true;

        // 將bikeData設為全局變量，方便其他函數訪問
        window.bikeData = {
            kawasaki: [
                { group: "仿賽系列", models: ["ZX-10R", "Ninja 400", "Ninja 650"] },
                { group: "街車系列", models: ["Z 900", "Z 650"] },
                { group: "復古系列", models: ["Z 900RS", "Z 650RS", ] }
            ],
            kymco: [
                { group: "輕型白牌", models:["Ionex系列"]},
                { group: "大型重機", models: ["AK 550", "XCITING 400"] },
                { group: "旗艦白牌", models: ["GP 125", "Like 125", "Many 125", "Racing S", "RTS 135", "KRV 180"] }
            ]
        };

        function updateModels() {
            const brand = document.getElementById('brandSelect').value;
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '<option value="" disabled selected>— 第二步：請選擇預約車款 —</option>';
            modelSelect.disabled = false;
            bikeData[brand].forEach(cat => {
                const group = document.createElement('optgroup');
                group.label = cat.group;
                cat.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m; opt.textContent = m;
                    group.appendChild(opt);
                });
                modelSelect.appendChild(group);
            });
        }

        function generate24HSlots() {
            const dateInput = document.getElementById('bookDate');
            const timeSelect = document.getElementById('timeSelect');
            const dateError = document.getElementById('dateError');
            const selectedDate = new Date(dateInput.value);
            const day = selectedDate.getDay(); // 0 是週日

            if (day === 0) {
                dateError.style.display = 'block';
                dateInput.value = '';
                timeSelect.innerHTML = '<option value="" disabled selected>預約時間</option>';
                return;
            } else {
                dateError.style.display = 'none';
            }

            // 定義營業時間範圍 (24小時制)
            let startHour = 9;
            let startMin = 30;
            let endHour = (day === 6) ? 18 : 20; // 週六 18:00，平日 20:30 (最後預約設為 20:00)
            let endMin = (day === 6) ? 0 : 30;

            let options = '<option value="" disabled selected>預約時間</option>';
            
            // 產生每半小時一個間隔的 24H 時段
            for (let h = startHour; h <= endHour; h++) {
                for (let m = 0; m < 60; m += 30) {
                    // 過濾掉 09:00 (因為 09:30 才開始)
                    if (h === 9 && m < 30) continue;
                    // 過濾掉超過打烊時間的時段
                    if (h === endHour && m > endMin) continue;

                    let hh = h.toString().padStart(2, '0');
                    let mm = m.toString().padStart(2, '0');
                    let timeStr = `${hh}:${mm}`;
                    options += `<option value="${timeStr}">${timeStr}</option>`;
                }
            }
            timeSelect.innerHTML = options;
        }
    </script>
    <!-- 引入行動選單 JavaScript -->
    <script src="js/mobile-menu.js"></script>
</body>
</html>